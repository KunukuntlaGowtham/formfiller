<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>SEVAK REGISTRY</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600;700&display=swap');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --black: #0f0f0f;
  --white: #f7f4ef;
  --off:   #edeae3;
  --yellow:#FFE500;
  --pink:  #FF2D78;
  --blue:  #1A56FF;
  --green: #00C16A;
  --orange:#FF6B00;
  --red:   #E63030;
  --b3: 3px solid var(--black);
  --b2: 2px solid var(--black);
  --sh:  6px 6px 0 var(--black);
  --shm: 4px 4px 0 var(--black);
  --shs: 3px 3px 0 var(--black);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--white);
  color: var(--black);
  min-height: 100vh;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#cfg-bar {
  background: var(--black);
  padding: 10px 20px;
  display: flex; flex-wrap: wrap; align-items: center; gap: 10px;
  border-bottom: 3px solid var(--yellow);
}
#cfg-bar label {
  font-family: 'Space Mono', monospace;
  font-size: 9px; color: var(--yellow);
  text-transform: uppercase; letter-spacing: 2px; white-space: nowrap;
}
.cfg-input {
  background: #1c1c1c; border: 2px solid #383838;
  color: #fff; padding: 5px 10px;
  font-family: 'Space Mono', monospace; font-size: 11px;
  outline: none; transition: border-color .15s;
}
.cfg-input:focus { border-color: var(--yellow); }
#cfg-url  { width: 220px; }
#cfg-key  { width: 190px; }
#cfg-table{ width: 110px; }
#cfg-gemini{ width: 170px; }
#btn-connect {
  background: var(--yellow); color: var(--black);
  border: none; padding: 6px 16px;
  font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 700;
  cursor: pointer; letter-spacing: .5px; text-transform: uppercase;
  transition: background .1s;
}
#btn-connect:hover { background: #ffe000; }
#conn-status { font-family: 'Space Mono', monospace; font-size: 10px; color: #666; white-space: nowrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOP NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.top-nav {
  background: var(--yellow);
  border-bottom: var(--b3);
  display: flex; align-items: stretch;
  position: sticky; top: 0; z-index: 100;
  min-height: 64px;
}

.brand {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 20px; border-right: var(--b3); flex-shrink: 0;
}
.brand-icon {
  width: 40px; height: 40px;
  background: var(--black); color: var(--yellow);
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; box-shadow: var(--shs); flex-shrink: 0;
}
.brand-name {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 26px; letter-spacing: 2px; line-height: 1;
}
.brand-table {
  font-family: 'Space Mono', monospace;
  font-size: 9px; color: rgba(0,0,0,.55);
  letter-spacing: 1.5px; margin-top: 2px;
}

/* TAB PILLS */
.nav-tabs {
  display: flex; align-items: stretch;
  padding: 0 16px; gap: 4px; flex: 1;
}
.tab-btn {
  background: transparent; border: none;
  font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 700;
  letter-spacing: .5px; padding: 0 20px; cursor: pointer;
  border-bottom: 4px solid transparent; color: rgba(0,0,0,.55);
  text-transform: uppercase; transition: all .15s;
  display: flex; align-items: center; gap: 7px;
}
.tab-btn:hover { color: var(--black); }
.tab-btn.active {
  border-bottom-color: var(--black); color: var(--black);
}
.tab-count {
  background: var(--black); color: var(--yellow);
  font-family: 'Space Mono', monospace; font-size: 10px;
  padding: 1px 6px; border-radius: 20px; line-height: 1.6;
}

.nav-right {
  display: flex; align-items: center; gap: 8px;
  padding: 0 16px; border-left: var(--b3); flex-shrink: 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS â€” SHARED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.nb { /* neubrutalist base */
  font-family: 'DM Sans', sans-serif; font-weight: 700;
  font-size: 13px; letter-spacing: .5px; text-transform: uppercase;
  padding: 9px 18px; border: var(--b3); cursor: pointer;
  display: inline-flex; align-items: center; gap: 7px;
  transition: all .08s; white-space: nowrap;
}
.nb:active { transform: translate(3px,3px); box-shadow: none !important; }

.nb-black { background: var(--black); color: var(--yellow); box-shadow: var(--shs); }
.nb-black:hover { background: #222; }
.nb-yellow{ background: var(--yellow); color: var(--black); box-shadow: var(--shs); }
.nb-yellow:hover { background: #ffe000; }
.nb-pink  { background: var(--pink);   color: #fff; box-shadow: var(--shs); }
.nb-pink:hover  { background: #e0005e; }
.nb-green { background: var(--green);  color: #fff; box-shadow: var(--shs); }
.nb-green:hover { background: #009e55; }
.nb-blue  { background: var(--blue);   color: #fff; box-shadow: var(--shs); }
.nb-blue:hover  { background: #0038cc; }
.nb-ghost { background: var(--white);  color: var(--black); box-shadow: var(--shs); }
.nb-ghost:hover { background: var(--off); }
.nb-red   { background: var(--red);    color: #fff; box-shadow: var(--shs); }
.nb-red:hover   { background: #c02020; }
.nb-orange{ background: var(--orange); color: #fff; box-shadow: var(--shs); }
.nb-sm { padding: 6px 13px; font-size: 12px; box-shadow: var(--shs); }
.nb:disabled { opacity: .35; cursor: not-allowed; transform: none !important; box-shadow: var(--shs) !important; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEARCH BAR (registry tab)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#search-bar {
  background: var(--off); border-bottom: var(--b3);
  padding: 12px 24px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
}
#search-bar .export-group { display: flex; gap: 6px; margin-left: auto; flex-shrink: 0; }
.search-wrap { position: relative; flex: 1; min-width: 200px; max-width: 420px; }
.search-wrap input {
  width: 100%; background: #fff; border: var(--b2);
  padding: 9px 14px 9px 42px;
  font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500;
  outline: none; transition: box-shadow .15s;
}
.search-wrap input:focus { box-shadow: var(--shs); }
.search-wrap .ico {
  position: absolute; left: 13px; top: 50%; transform: translateY(-50%);
  font-size: 16px; pointer-events: none; opacity: .4;
}
.nb-select {
  background: #fff; border: var(--b2);
  padding: 9px 12px; font-family: 'DM Sans', sans-serif;
  font-size: 13px; font-weight: 600; cursor: pointer;
  outline: none; box-shadow: var(--shs);
}
#ai-badge {
  display: none; align-items: center; gap: 8px;
  background: var(--green); color: #fff; border: var(--b2);
  padding: 6px 12px; font-size: 12px; font-weight: 700;
  letter-spacing: .5px; box-shadow: var(--shs);
}
#ai-badge.on { display: flex; }
#ai-badge button { background: none; border: none; color: #fff; font-size: 16px; font-weight: 900; cursor: pointer; line-height: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI DRAWER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#ai-drawer {
  display: none; background: var(--black);
  border-bottom: 4px solid var(--yellow);
  padding: 14px 24px; align-items: center; gap: 10px; flex-wrap: wrap;
}
#ai-drawer.open { display: flex; }
#ai-drawer input {
  flex: 1; min-width: 200px; background: #1c1c1c; border: 2px solid #444;
  color: #fff; padding: 10px 16px;
  font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none;
}
#ai-drawer input:focus { border-color: var(--yellow); }
#ai-drawer input::placeholder { color: #555; }
.ai-thinking { display: none; align-items: center; gap: 6px;
  font-family: 'Space Mono', monospace; font-size: 11px; color: var(--yellow); }
.ai-thinking.on { display: flex; }
.dot { display: inline-block; width: 6px; height: 6px; background: var(--yellow); border-radius: 50%; animation: blink 1.2s infinite; }
.dot:nth-child(2){animation-delay:.2s} .dot:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page { display: none; }
.page.active { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LIST PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#pg-list { padding: 24px; }

.stats-strip {
  display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 22px;
}
.stat {
  background: #fff; border: var(--b3); box-shadow: var(--shm);
  padding: 14px 22px; min-width: 110px;
  position: relative; overflow: hidden;
}
.stat::after {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
}
.stat.c1::after { background: var(--blue); }
.stat.c2::after { background: var(--green); }
.stat.c3::after { background: var(--orange); }
.stat.c4::after { background: var(--pink); }
.stat.c5::after { background: var(--yellow); border-top: 1px solid #ccc; }
.stat .v { font-family: 'Bebas Neue', sans-serif; font-size: 40px; line-height: 1; }
.stat .l { font-family: 'Space Mono', monospace; font-size: 9px; color: #888; text-transform: uppercase; letter-spacing: 1.5px; margin-top: 2px; }

.table-card {
  border: var(--b3); box-shadow: var(--sh); background: #fff; overflow: hidden;
}
.table-scroll { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
thead tr { background: var(--black); }
th {
  padding: 11px 16px; text-align: left;
  font-family: 'Space Mono', monospace; font-size: 9px;
  text-transform: uppercase; letter-spacing: 1.5px; color: var(--yellow);
  white-space: nowrap; font-weight: 400;
}
tbody tr {
  border-bottom: 2px solid #e8e4dc; cursor: pointer;
  transition: background .1s;
}
tbody tr:last-child { border-bottom: none; }
tbody tr:hover { background: #FFFCE0; }
tbody tr:hover .arr { opacity: 1; }
td { padding: 13px 16px; font-size: 14px; color: #2a2a2a; vertical-align: middle; }

.av {
  width: 40px; height: 40px; flex-shrink: 0;
  border: var(--b2); box-shadow: 2px 2px 0 var(--black);
  background: var(--yellow); display: flex; align-items: center; justify-content: center;
  overflow: hidden;
}
.av img { width: 100%; height: 100%; object-fit: cover; }
.av-init { font-family: 'Bebas Neue', sans-serif; font-size: 20px; color: var(--black); }

.id-tag {
  font-family: 'Space Mono', monospace; font-size: 11px;
  background: var(--black); color: var(--yellow); padding: 3px 8px;
  display: inline-block; white-space: nowrap;
}
.name-cell strong { display: block; font-weight: 700; font-size: 14px; }
.name-cell span   { display: block; font-size: 11px; color: #888; font-family: 'Space Mono', monospace; margin-top: 1px; }

.gpill {
  display: inline-block; padding: 3px 10px; border: var(--b2);
  font-size: 11px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
}
.gm { background: #c8e6ff; }
.gf { background: #ffd6ea; }
.go { background: #fff3cc; }

.loc-cell div:first-child { font-weight: 700; }
.loc-cell div:last-child  { font-size: 11px; color: #888; font-family: 'Space Mono', monospace; }

.arr { opacity: 0; font-size: 20px; font-weight: 900; transition: opacity .1s; color: #aaa; }

/* Empty */
#empty-state { display: none; background: #fff; text-align: center; padding: 80px 20px; border-top: var(--b3); }
#empty-state .big { font-family: 'Bebas Neue', sans-serif; font-size: 72px; color: #ddd; }
#empty-state p { font-family: 'Space Mono', monospace; font-size: 11px; color: #aaa; margin-top: 8px; }

/* Pagination */
.pag {
  display: flex; align-items: center; justify-content: space-between;
  padding: 13px 20px; border-top: var(--b3); background: var(--off);
  flex-wrap: wrap; gap: 10px;
}
.pag-info { font-family: 'Space Mono', monospace; font-size: 10px; color: #888; text-transform: uppercase; }
.pag-btns { display: flex; gap: 4px; }
.pg {
  background: #fff; border: var(--b2); color: var(--black);
  padding: 5px 12px; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 700;
  cursor: pointer; box-shadow: 2px 2px 0 var(--black); transition: all .08s;
}
.pg:hover { background: var(--black); color: var(--yellow); }
.pg.on { background: var(--black); color: var(--yellow); }
.pg:disabled { opacity: .3; cursor: default; box-shadow: none; }
.pg:active { transform: translate(2px,2px); box-shadow: none; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DETAIL PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#pg-detail { padding: 24px; max-width: 980px; margin: 0 auto; }

.d-hero {
  background: var(--black); color: var(--white);
  border: var(--b3); box-shadow: var(--sh);
  padding: 28px 30px; display: flex; gap: 26px; align-items: flex-start;
  margin-bottom: 18px; flex-wrap: wrap;
}
.d-av {
  width: 108px; height: 108px; flex-shrink: 0;
  border: 3px solid var(--yellow); box-shadow: 5px 5px 0 var(--yellow);
  background: #222; display: flex; align-items: center; justify-content: center;
  overflow: hidden;
}
.d-av img { width: 100%; height: 100%; object-fit: cover; }
.d-av-init { font-family: 'Bebas Neue', sans-serif; font-size: 48px; color: var(--yellow); }

.d-info { flex: 1; min-width: 180px; }
.d-pre  { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--yellow); letter-spacing: 3px; margin-bottom: 6px; }
.d-info h1 { font-family: 'Bebas Neue', sans-serif; font-size: 44px; letter-spacing: 2px; line-height: 1; }
.d-info .sub { font-size: 13px; color: #888; margin-top: 4px; font-family: 'Space Mono', monospace; }
.d-pills { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 14px; }

.d-actions { display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }

.d-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.d-full { grid-column: 1/-1; }

.d-section { border: var(--b3); box-shadow: var(--shm); background: #fff; overflow: hidden; }
.d-head {
  background: var(--black); color: var(--yellow);
  padding: 9px 18px; font-family: 'Space Mono', monospace;
  font-size: 9px; text-transform: uppercase; letter-spacing: 2px;
  display: flex; align-items: center; gap: 8px;
}
.d-row { display: flex; align-items: baseline; border-bottom: 1.5px solid #eae7e0; padding: 10px 18px; }
.d-row:last-child { border-bottom: none; }
.d-lbl { font-family: 'Space Mono', monospace; font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: #aaa; min-width: 130px; flex-shrink: 0; }
.d-val { font-size: 15px; font-weight: 600; color: var(--black); word-break: break-all; }
.d-val.code { font-family: 'Space Mono', monospace; font-size: 12px; background: var(--black); color: var(--yellow); padding: 3px 8px; }
.d-val.empty { color: #ccc; font-style: italic; font-weight: 400; font-size: 13px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REGISTRATION PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#pg-register { padding: 28px 24px 80px; max-width: 1000px; margin: 0 auto; }

.reg-header { margin-bottom: 28px; }
.reg-header h2 { font-family: 'Bebas Neue', sans-serif; font-size: 40px; letter-spacing: 2px; }
.reg-header p  { font-size: 14px; color: #666; margin-top: 4px; }

/* Section blocks */
.reg-section {
  background: #fff; border: var(--b3); box-shadow: var(--sh);
  overflow: hidden; margin-bottom: 20px;
}
.reg-sect-head {
  background: var(--black); color: var(--yellow);
  padding: 13px 22px; display: flex; align-items: center; gap: 10px;
  border-bottom: var(--b3);
}
.reg-sect-head .ico { font-size: 18px; }
.reg-sect-head h3 { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 1px; }
.reg-sect-head p  { font-size: 12px; color: rgba(255,255,255,.5); margin-top: 1px; }
.reg-sect-body { padding: 22px; }

/* Form grid */
.fg { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: 16px; }
.ff { grid-column: 1/-1; }

.fld { display: flex; flex-direction: column; gap: 5px; }
.fld label {
  font-family: 'Space Mono', monospace; font-size: 9px;
  text-transform: uppercase; letter-spacing: 1.5px; color: #888; font-weight: 700;
}
.fld label .req { color: var(--pink); margin-left: 2px; }
.fld input, .fld select {
  background: var(--white); border: var(--b2); color: var(--black);
  padding: 10px 13px; font-family: 'DM Sans', sans-serif; font-size: 14px;
  font-weight: 500; outline: none; transition: box-shadow .15s, border-color .15s;
  width: 100%;
}
.fld input:focus, .fld select:focus { box-shadow: var(--shs); border-color: var(--black); }
.fld input.ai-fill { border-color: var(--green) !important; box-shadow: 0 0 0 2px rgba(0,193,106,.2) !important; }

/* Upload zone */
.upload-zone {
  border: 3px dashed #ccc; padding: 24px 20px; text-align: center;
  cursor: pointer; position: relative; transition: all .2s;
}
.upload-zone:hover, .upload-zone.drag { border-color: var(--black); background: #fafaf5; box-shadow: var(--shs); }
.upload-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; padding: 0; border: none; }
.upload-zone .uz-ico { font-size: 2.4rem; margin-bottom: 8px; }
.upload-zone p { font-size: 13px; color: #888; }
.upload-zone strong { color: var(--black); }

/* Image editor */
.img-editor {
  display: none; border: var(--b3); box-shadow: var(--shm); overflow: hidden; margin-top: 12px;
}
.img-editor.show { display: block; }
.editor-toolbar {
  background: var(--off); border-bottom: var(--b2);
  padding: 10px 14px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
}
.editor-toolbar span { font-family: 'Space Mono', monospace; font-size: 9px; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-right: 4px; }
.canvas-wrap { overflow: auto; max-height: 280px; background: #111; display: flex; align-items: center; justify-content: center; min-height: 100px; }
canvas.ec { cursor: default; display: block; max-width: 100%; }
canvas.ec.crop { cursor: crosshair; }
.editor-footer { background: var(--off); border-top: var(--b2); padding: 10px 14px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

/* Photo + doc layout */
.media-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
.preview-box {
  background: #f5f2ee; border: var(--b2);
  min-height: 200px; display: flex; align-items: center; justify-content: center;
  font-size: 13px; color: #aaa; cursor: pointer; overflow: hidden; position: relative;
  transition: border-color .15s;
}
.preview-box:hover { border-color: var(--black); }
.preview-box img { width: 100%; height: 100%; object-fit: contain; }
.zoom-hint {
  position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,.75); color: var(--yellow); font-size: 10px; font-family: 'Space Mono', monospace;
  padding: 3px 10px; white-space: nowrap; opacity: 0; transition: opacity .2s;
}
.preview-box:hover .zoom-hint { opacity: 1; }

/* AI status */
.ai-status { display: flex; align-items: flex-start; gap: 10px; padding: 12px 16px;
  font-size: 13px; margin-top: 12px; border: var(--b2); }
.ai-status.proc { background: rgba(255,229,0,.1); border-color: var(--yellow); color: var(--black); }
.ai-status.done { background: rgba(0,193,106,.08); border-color: var(--green); color: #006c3a; }
.ai-status.fail { background: rgba(230,48,48,.08);  border-color: var(--red);   color: var(--red); }
.spinner { width: 15px; height: 15px; border: 2px solid currentColor; border-top-color: transparent; border-radius: 50%; animation: spin .7s linear infinite; flex-shrink: 0; margin-top: 2px; }
@keyframes spin { to { transform: rotate(360deg); } }

.size-badge {
  font-family: 'Space Mono', monospace; font-size: 10px;
  background: var(--black); color: var(--yellow); padding: 3px 8px;
}

.how-box {
  background: var(--off); border: var(--b2); padding: 16px;
  font-size: 13px; line-height: 1.8; color: #555;
}
.how-box strong { color: var(--black); }

.addr-bar {
  margin-top: 16px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
  padding: 14px; background: var(--off); border: var(--b2);
}
.addr-bar p { font-size: 12px; color: #888; flex: 1; }
#addr-ai-status { font-size: 12px; }

/* Submit section */
.submit-section {
  background: var(--black); border: var(--b3); box-shadow: var(--sh);
  padding: 28px 24px; text-align: center; margin-top: 20px;
}
.submit-section h3 { font-family: 'Bebas Neue', sans-serif; font-size: 32px; color: var(--yellow); letter-spacing: 2px; }
.submit-section p  { font-size: 13px; color: #888; margin-top: 4px 0 16px; }
.submit-section .nb { margin-top: 16px; font-size: 16px; padding: 14px 48px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.72); z-index: 500;
  display: none; justify-content: center; align-items: flex-start;
  padding: 30px 16px; overflow-y: auto;
}
.overlay.open { display: flex; }
.modal {
  background: var(--white); border: var(--b3); box-shadow: var(--sh);
  width: 100%; max-width: 680px; padding: 32px; position: relative;
  animation: pop .2s cubic-bezier(.34,1.56,.64,1); margin: auto;
}
@keyframes pop { from{opacity:0;transform:scale(.94) translateY(-12px);}to{opacity:1;transform:none;} }
.modal-title {
  font-family: 'Bebas Neue', sans-serif; font-size: 34px; letter-spacing: 2px;
  border-bottom: var(--b3); padding-bottom: 14px; margin-bottom: 22px;
}
.modal-title .hi { color: var(--pink); }
.btn-x {
  position: absolute; top: 14px; right: 16px;
  background: var(--black); color: var(--yellow); border: none;
  width: 32px; height: 32px; font-size: 16px; font-weight: 900;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
}
.btn-x:hover { background: #333; }

.mgrid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.mfull { grid-column: 1/-1; }
.modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 22px; padding-top: 18px; border-top: var(--b2); }

.photo-row { display: flex; align-items: center; gap: 14px; }
.photo-thumb {
  width: 60px; height: 60px; border: var(--b3); box-shadow: var(--shs);
  background: var(--yellow); display: flex; align-items: center;
  justify-content: center; font-size: 22px; overflow: hidden; flex-shrink: 0;
}
.photo-thumb img { width: 100%; height: 100%; object-fit: cover; }

/* Lightbox */
.lightbox {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.95); z-index: 3000;
  align-items: center; justify-content: center; padding: 20px; cursor: zoom-out;
}
.lightbox.on { display: flex; }
.lightbox img { max-width: 95vw; max-height: 95vh; object-fit: contain; }

/* Toast */
#toast {
  position: fixed; bottom: 22px; right: 22px;
  background: var(--black); color: var(--yellow);
  padding: 12px 20px; border: var(--b3); box-shadow: var(--sh);
  font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 700;
  letter-spacing: .3px; z-index: 9999; max-width: 320px;
  transform: translateY(70px); opacity: 0;
  transition: all .25s cubic-bezier(.34,1.56,.64,1);
}
#toast.show { transform: none; opacity: 1; }
#toast.ok  { background: var(--green); color: #fff; border-color: var(--black); }
#toast.err { background: var(--red);   color: #fff; border-color: var(--black); }
#toast.inf { background: var(--blue);  color: #fff; border-color: var(--black); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AI UPLOAD PROGRESS BANNER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#ai-progress-banner {
  display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 9000;
  background: var(--black); border-bottom: 3px solid var(--yellow);
  padding: 0; overflow: hidden;
}
#ai-progress-banner.show { display: block; }
#ai-progress-inner {
  display: flex; align-items: center; gap: 14px;
  padding: 10px 24px;
}
#ai-progress-icon { font-size: 20px; }
#ai-progress-text {
  font-family: 'Space Mono', monospace; font-size: 11px;
  color: var(--yellow); letter-spacing: 1.5px; text-transform: uppercase; flex: 1;
}
#ai-progress-step {
  font-family: 'Space Mono', monospace; font-size: 10px; color: #555;
}
#ai-progress-bar-track {
  height: 4px; background: #222; width: 100%;
}
#ai-progress-bar-fill {
  height: 4px; background: var(--yellow);
  width: 0%; transition: width 0.4s ease;
  box-shadow: 0 0 12px rgba(255,229,0,0.6);
}

/* Doc person-crop button */
.doc-crop-person-bar {
  margin-top: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
  padding: 10px 14px; background: #1c1c1c; border: 2px solid #333;
}
.doc-crop-person-bar p { font-size: 11px; color: #888; flex: 1; font-family: 'Space Mono', monospace; }
#crop-person-status { font-size: 11px; font-family: 'Space Mono', monospace; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BULK REGISTER PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#pg-bulk { display:none; }
#pg-bulk.active { display:flex; height:calc(100vh - 60px); overflow:hidden; }

/* sidebar */
.bk-sidebar {
  width:190px; flex-shrink:0; background:var(--black);
  border-right:3px solid #222; display:flex; flex-direction:column; overflow:hidden;
}
.bk-sidebar-hd {
  padding:10px 12px; border-bottom:2px solid #2a2a2a;
  font-family:'Space Mono',monospace; font-size:9px; color:var(--yellow);
  letter-spacing:2px; display:flex; align-items:center; justify-content:space-between;
}
.bk-list { flex:1; overflow-y:auto; padding:6px; display:flex; flex-direction:column; gap:5px; }
.bk-list::-webkit-scrollbar { width:3px; }
.bk-list::-webkit-scrollbar-thumb { background:#444; }
.bk-card {
  border:2px solid #2e2e2e; cursor:pointer; position:relative;
  transition:border-color .12s;
}
.bk-card:hover  { border-color:#555; }
.bk-card.active { border-color:var(--yellow); }
.bk-card.saved  { border-color:var(--green); }
.bk-card-img { width:100%; height:65px; object-fit:cover; display:block; background:#1a1a1a; }
.bk-card-ph  { width:100%; height:65px; background:#1a1a1a; display:flex; align-items:center; justify-content:center; font-size:26px; }
.bk-card-info { padding:5px 7px; }
.bk-card-name { font-size:11px; font-weight:700; color:#ddd; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.bk-card-id   { font-family:'Space Mono',monospace; font-size:8px; color:#555; margin-top:1px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.bk-card-sts  { position:absolute; top:3px; right:3px; font-size:11px; }
.bk-del-btn   {
  position:absolute; top:3px; left:3px; background:var(--red); color:#fff;
  border:none; width:16px; height:16px; font-size:9px; font-weight:900;
  cursor:pointer; display:none; align-items:center; justify-content:center;
}
.bk-card:hover .bk-del-btn { display:flex; }

.bk-sidebar-ft { padding:8px; border-top:2px solid #2a2a2a; display:flex; flex-direction:column; gap:5px; }

/* main form panel */
.bk-panel { flex:1; overflow-y:auto; background:var(--white); display:flex; flex-direction:column; }
.bk-panel::-webkit-scrollbar { width:5px; }
.bk-panel::-webkit-scrollbar-thumb { background:#ccc; }

.bk-topbar {
  position:sticky; top:0; z-index:50; background:var(--yellow);
  border-bottom:var(--b3); padding:9px 18px;
  display:flex; align-items:center; gap:10px; flex-wrap:wrap;
}
.bk-nav { background:var(--black); color:var(--yellow); border:2px solid var(--black); padding:5px 12px; font-weight:700; font-size:12px; cursor:pointer; }
.bk-nav:disabled { opacity:.3; cursor:default; }
.bk-counter { font-family:'Bebas Neue',sans-serif; font-size:22px; color:var(--black); letter-spacing:1px; }
.bk-person-lbl { font-family:'Space Mono',monospace; font-size:10px; color:rgba(0,0,0,.5); }

.bk-empty {
  flex:1; display:flex; flex-direction:column; align-items:center;
  justify-content:center; gap:14px; color:#aaa; padding:40px;
}
.bk-empty .ico { font-size:56px; }
.bk-empty h2 { font-family:'Bebas Neue',sans-serif; font-size:32px; letter-spacing:2px; color:#ccc; }
.bk-empty p  { font-family:'Space Mono',monospace; font-size:10px; text-align:center; line-height:2; }

/* per-person form: hidden by default, shown when active */
.bk-person-form { display:none; }
.bk-person-form.active { display:block; }

/* progress */
.bk-prog-wrap { background:#e8e4dc; border:var(--b2); height:20px; overflow:hidden; margin:0 20px 8px; }
.bk-prog-fill { height:100%; background:var(--green); transition:width .3s; display:flex; align-items:center; padding-left:8px; }
.bk-prog-fill span { font-family:'Space Mono',monospace; font-size:9px; color:#fff; white-space:nowrap; }

/* field error highlight */
.fld.berr input, .fld.berr select { border-color:var(--red)!important; background:#fff5f5!important; }

/* â”€â”€ Checkbox selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chk-col { width: 36px; text-align: center; padding: 0 4px !important; }
.row-chk {
  width: 16px; height: 16px; cursor: pointer; accent-color: var(--yellow);
  border: var(--b2); appearance: auto;
}
tbody tr.selected-row { background: #FFFBD0 !important; }

/* â”€â”€ Bulk action bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#bulk-action-bar {
  display: none;
  background: var(--black); color: var(--yellow);
  border-bottom: 3px solid var(--yellow);
  padding: 10px 24px; align-items: center; gap: 12px; flex-wrap: wrap;
  position: sticky; top: 64px; z-index: 90;
}
#bulk-action-bar.on { display: flex; }
#bulk-sel-count {
  font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 1px;
}
#bulk-sel-label { font-family: 'Space Mono', monospace; font-size: 10px; color: #aaa; }
.bulk-sep { width: 2px; height: 28px; background: #333; flex-shrink: 0; }

/* â”€â”€ Inline code edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.code-cell-td { min-width: 90px; }
.code-display:hover {
  background: var(--yellow) !important;
  color: var(--black) !important;
  outline: 2px solid var(--black);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:700px){
  .top-nav { flex-wrap: wrap; min-height: auto; }
  .brand { border-right: none; }
  .nav-tabs { border-top: var(--b2); }
  .d-sections { grid-template-columns: 1fr; }
  .d-full { grid-column: 1; }
  .mgrid { grid-template-columns: 1fr; }
  .mfull { grid-column: 1; }
  .media-grid { grid-template-columns: 1fr; }
  #pg-register, #pg-detail, #pg-list { padding: 16px; }
}
</style>
</head>
<body>

<!-- â•â•â• CONFIG BAR â•â•â• -->
<div id="cfg-bar">
  <label>Supabase URL</label>
  <input class="cfg-input" id="cfg-url" placeholder="https://xxxx.supabase.co" />
  <label>Anon Key</label>
  <input class="cfg-input" id="cfg-key" type="password" placeholder="eyJ..." />
  <label>Table</label>
  <input class="cfg-input" id="cfg-table" value="customers" placeholder="table name" />
  <label>Gemini Key</label>
  <input class="cfg-input" id="cfg-gemini" type="password" placeholder="AIzaâ€¦ (for OCR)" />
  <button id="btn-connect">âš¡ Connect</button>
  <span id="conn-status"></span>
</div>

<!-- â•â•â• TOP NAV â•â•â• -->
<nav class="top-nav">
  <div class="brand">
    <div class="brand-icon">âš¡</div>
    <div>
      <div class="brand-name">SEVAK REGISTRY</div>
      <div class="brand-table">TABLE: <strong id="hdr-table">customers</strong></div>
    </div>
  </div>
  <div class="nav-tabs">
    <button class="tab-btn active" data-tab="list" onclick="switchTab('list')">
      ğŸ“‹ RECORDS <span class="tab-count" id="tc-records">0</span>
    </button>
    <button class="tab-btn" data-tab="register" onclick="switchTab('register')">
      âœš REGISTER NEW
    </button>
    <button class="tab-btn" data-tab="bulk" onclick="switchTab('bulk')">
      âš¡ BULK REGISTER
    </button>
  </div>
  <div class="nav-right">
    <button class="nb nb-black nb-sm" id="btn-ai-toggle">âœ¦ AI FILTER</button>
    <button class="nb nb-pink nb-sm" onclick="openAdd()">ï¼‹ ADD</button>
  </div>
</nav>

<!-- â•â•â• SEARCH BAR (registry) â•â•â• -->
<div id="search-bar">
  <div class="search-wrap">
    <span class="ico">âŒ•</span>
    <input type="text" id="search-input" placeholder="Search name, ID, mobile, cityâ€¦" oninput="quickSearch()" />
  </div>
  <select class="nb-select" id="flt-code" onchange="applyFilters()">
    <option value="">ALL CODES</option>
  </select>
  <select class="nb-select" id="flt-gender" onchange="applyFilters()">
    <option value="">ALL GENDERS</option>
    <option>Male</option><option>Female</option><option>Other</option>
  </select>
  <select class="nb-select" id="flt-state" onchange="applyFilters()">
    <option value="">ALL STATES</option>
  </select>
  <div id="ai-badge">
    <span id="ai-badge-txt"></span>
    <button onclick="clearAi()">âœ•</button>
  </div>
  <div style="display:flex;gap:6px;margin-left:auto;flex-shrink:0;">
    <button class="nb nb-green nb-sm" onclick="exportExcel()" title="Export filtered list to Excel">ğŸ“Š EXCEL</button>
    <button class="nb nb-red nb-sm" onclick="exportPDF()" title="Export filtered list to PDF roster">ğŸ“„ PDF</button>
  </div>
</div>

<!-- â•â•â• AI DRAWER â•â•â• -->
<div id="ai-drawer">
  <input id="ai-q" placeholder='e.g. "males from Telangana" or "born after 1990"' />
  <button class="nb nb-yellow nb-sm" onclick="runAi()">SEARCH â–¶</button>
  <div class="ai-thinking" id="ai-thinking">
    <span>FILTERING</span><span class="dot"></span><span class="dot"></span><span class="dot"></span>
  </div>
</div>

<!-- â•â•â• BULK ACTION BAR â•â•â• -->
<div id="bulk-action-bar">
  <span id="bulk-sel-count">0</span>
  <span id="bulk-sel-label">SELECTED</span>
  <div class="bulk-sep"></div>
  <button class="nb nb-yellow nb-sm" onclick="openBulkModal('copy')">ğŸ“‹ BULK COPY</button>
  <button class="nb nb-orange nb-sm" onclick="openBulkModal('move')">ğŸ“¦ BULK MOVE</button>
  <button class="nb nb-green nb-sm" onclick="openReassignModal()">ğŸ· REASSIGN CODE</button>
  <div class="bulk-sep"></div>
  <button class="nb nb-ghost nb-sm" onclick="selectAllVisible()">â˜‘ SELECT ALL VISIBLE</button>
  <button class="nb nb-ghost nb-sm" onclick="clearSelection()">âœ• DESELECT ALL</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: LIST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="pg-list">
  <div style="padding:24px;">
    <div class="stats-strip">
      <div class="stat c1"><div class="v" id="s-total">0</div><div class="l">TOTAL</div></div>
      <div class="stat c2"><div class="v" id="s-shown">0</div><div class="l">SHOWN</div></div>
      <div class="stat c3"><div class="v" id="s-states">0</div><div class="l">STATES</div></div>
      <div class="stat c4"><div class="v" id="s-male">0</div><div class="l">MALE</div></div>
      <div class="stat c5"><div class="v" id="s-female">0</div><div class="l">FEMALE</div></div>
    </div>

    <div class="table-card">
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th class="chk-col"><input type="checkbox" id="chk-all" class="row-chk" onclick="toggleAllOnPage(this)" title="Select all on this page"/></th>
              <th>PHOTO</th><th>ID</th><th>CODE</th><th>NAME</th><th>DOB</th>
              <th>GENDER</th><th>MOBILE</th><th>LOCATION</th><th></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div id="empty-state">
        <div class="big">NO DATA</div>
        <p>CONNECT TO SUPABASE OR ADJUST YOUR FILTERS</p>
      </div>
      <div class="pag" id="pag-bar">
        <div class="pag-info" id="pag-info"></div>
        <div class="pag-btns" id="pag-btns"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: DETAIL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="pg-detail">
  <button class="nb nb-ghost" style="margin:20px 24px 0;box-shadow:var(--shm);" onclick="switchTab('list')">â† BACK TO LIST</button>

  <div style="padding:16px 24px 40px;">
    <div class="d-hero">
      <div class="d-av" id="d-avatar"></div>
      <div class="d-info">
        <div class="d-pre">MEMBER PROFILE</div>
        <h1 id="d-name">â€”</h1>
        <div class="sub" id="d-sub"></div>
        <div class="d-pills" id="d-pills"></div>
      </div>
      <div class="d-actions">
        <button class="nb nb-yellow" onclick="openEdit()">âœ EDIT RECORD</button>
        <button class="nb nb-blue" onclick="openCopyModal()">ğŸ“‹ COPY TO TABLE</button>
        <button class="nb nb-orange" onclick="openMoveModal()">ğŸ“¦ MOVE TO TABLE</button>
        <button class="nb nb-red" onclick="openDel()">âœ• DELETE</button>
      </div>
    </div>

    <div class="d-sections">
      <div class="d-section">
        <div class="d-head">ğŸ‘¤ PERSONAL INFO</div>
        <div class="d-row"><div class="d-lbl">ID NUMBER</div><div class="d-val code" id="d-idNumber"></div></div>
        <div class="d-row"><div class="d-lbl">CODE</div><div class="d-val code" id="d-code"></div></div>
        <div class="d-row"><div class="d-lbl">SEVAK NAME</div><div class="d-val" id="d-sevakName"></div></div>
        <div class="d-row"><div class="d-lbl">SURNAME</div><div class="d-val" id="d-surName"></div></div>
        <div class="d-row"><div class="d-lbl">FATHER/SPOUSE</div><div class="d-val" id="d-fatherOrSpouseName"></div></div>
        <div class="d-row"><div class="d-lbl">DATE OF BIRTH</div><div class="d-val" id="d-dob"></div></div>
        <div class="d-row"><div class="d-lbl">GENDER</div><div class="d-val" id="d-gender"></div></div>
      </div>
      <div class="d-section">
        <div class="d-head">ğŸ“ CONTACT</div>
        <div class="d-row"><div class="d-lbl">MOBILE NO</div><div class="d-val" id="d-mobileNo"></div></div>
        <div class="d-row"><div class="d-lbl">EMAIL</div><div class="d-val" id="d-email"></div></div>
      </div>
      <div class="d-section d-full">
        <div class="d-head">ğŸ“ ADDRESS</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;">
          <div class="d-row"><div class="d-lbl">DOOR NO</div><div class="d-val" id="d-doorNo"></div></div>
          <div class="d-row"><div class="d-lbl">STREET</div><div class="d-val" id="d-street"></div></div>
          <div class="d-row"><div class="d-lbl">CITY</div><div class="d-val" id="d-city"></div></div>
          <div class="d-row"><div class="d-lbl">DISTRICT</div><div class="d-val" id="d-district"></div></div>
          <div class="d-row"><div class="d-lbl">STATE</div><div class="d-val" id="d-state"></div></div>
          <div class="d-row"><div class="d-lbl">PINCODE</div><div class="d-val" id="d-pincode"></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: REGISTER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="pg-register">
  <div class="reg-header">
    <h2>REGISTER NEW SEVAK</h2>
    <p>Fill manually, or use Gemini AI OCR to auto-fill from a handwritten form photo</p>
  </div>

  <!-- AI OCR -->
  <div class="reg-section">
    <div class="reg-sect-head">
      <span class="ico">ğŸ¤–</span>
      <div>
        <h3>AI HANDWRITING RECOGNITION</h3>
        <p>Upload handwritten form â†’ Edit â†’ Gemini scans â†’ Fields auto-filled</p>
      </div>
    </div>
    <div class="reg-sect-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start;">
        <div>
          <div class="upload-zone" id="ai-zone">
            <input type="file" id="ai-file" accept="image/*" />
            <div class="uz-ico">ğŸ“„</div>
            <p><strong>Click or drag & drop</strong> handwritten form image</p>
          </div>
          <div class="img-editor" id="ai-editor">
            <div class="editor-toolbar">
              <span>EDIT:</span>
              <button class="nb nb-ghost nb-sm" onclick="aiEd.rotate(-90)">â†º LEFT</button>
              <button class="nb nb-ghost nb-sm" onclick="aiEd.rotate(90)">â†» RIGHT</button>
              <button class="nb nb-ghost nb-sm" id="ai-crop-btn" onclick="aiEd.toggleCrop()">âœ‚ CROP</button>
              <button class="nb nb-yellow nb-sm" id="ai-apply-btn" style="display:none" onclick="aiEd.applyCrop()">âœ… APPLY</button>
              <button class="nb nb-ghost nb-sm" onclick="aiEd.reset()">â†º RESET</button>
            </div>
            <div class="canvas-wrap" id="ai-canvas-wrap"><canvas id="ai-canvas" class="ec"></canvas></div>
            <div class="editor-footer">
              <button class="nb nb-blue nb-sm" id="btn-ocr" onclick="runOcr()">ğŸ” RUN GEMINI SCAN</button>
              <span class="size-badge" id="ai-size"></span>
            </div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div class="how-box">
            <strong>HOW IT WORKS:</strong><br/>
            1ï¸âƒ£ Upload photo of handwritten form<br/>
            2ï¸âƒ£ Crop / rotate for clarity<br/>
            3ï¸âƒ£ Click <em>Run Gemini Scan</em><br/>
            4ï¸âƒ£ Fields auto-filled (green = AI filled)<br/>
            5ï¸âƒ£ Verify & correct before submitting
          </div>
          <div id="ocr-status" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FORM FIELDS -->
  <div class="reg-section">
    <div class="reg-sect-head">
      <span class="ico">ğŸ“</span>
      <div>
        <h3>REGISTRATION DETAILS</h3>
        <p>Fill manually or use AI auto-fill above</p>
      </div>
    </div>
    <div class="reg-sect-body">
      <div class="fg">
        <div class="fld"><label>ID Number <span class="req">*</span></label><input id="r-idNumber" placeholder="e.g. SVK-0001" /></div>
        <div class="fld"><label>Code <span class="req">*</span></label><input id="r-code" placeholder="e.g. CODE001" /></div>
        <div class="fld"><label>Sevak Name <span class="req">*</span></label><input id="r-sevakName" placeholder="First / Given Name" /></div>
        <div class="fld"><label>Surname</label><input id="r-surName" placeholder="Last Name" /></div>
        <div class="fld"><label>Father / Spouse Name</label><input id="r-fatherOrSpouseName" placeholder="Father or Spouse" /></div>
        <div class="fld"><label>Date of Birth <span class="req">*</span></label><input id="r-dob" placeholder="DD/MM/YYYY" maxlength="10" /></div>
        <div class="fld"><label>Mobile <span class="req">*</span></label><input id="r-mobileNo" type="tel" placeholder="10-digit mobile" maxlength="10" /></div>
        <div class="fld"><label>Email</label><input id="r-email" type="email" placeholder="email@example.com" /></div>
        <div class="fld"><label>Gender <span class="req">*</span></label>
          <select id="r-gender">
            <option value="">Select Gender</option>
            <option>Male</option><option>Female</option><option>Other</option>
          </select>
        </div>
        <div class="fld"><label>State <span class="req">*</span></label><input id="r-state" placeholder="State" /></div>
        <div class="fld"><label>District</label><input id="r-district" placeholder="District" /></div>
        <div class="fld"><label>City</label><input id="r-city" placeholder="City / Town" /></div>
        <div class="fld"><label>Street</label><input id="r-street" placeholder="Street / Colony" /></div>
        <div class="fld"><label>Door No</label><input id="r-doorNo" placeholder="Door / Flat No." /></div>
        <div class="fld"><label>Pincode</label><input id="r-pincode" placeholder="6-digit pincode" maxlength="6" /></div>
      </div>
      <!-- Address AI -->
      <div class="addr-bar">
        <button class="nb nb-blue nb-sm" onclick="runAddressFill()">ğŸŒ SMART-FILL ADDRESS</button>
        <p>Fixes spelling Â· Fills missing city / district / state / pincode using Gemini</p>
        <span id="addr-ai-status"></span>
      </div>
    </div>
  </div>

  <!-- PHOTO -->
  <div class="reg-section">
    <div class="reg-sect-head">
      <span class="ico">ğŸ“¸</span>
      <div><h3>PHOTO UPLOAD</h3><p>Crop & rotate Â· Compress manually Â· Stored as Base64</p></div>
    </div>
    <div class="reg-sect-body">
      <div class="media-grid">
        <div>
          <div class="upload-zone" id="ph-zone">
            <input type="file" id="ph-file" accept="image/*" />
            <div class="uz-ico">ğŸ–¼ï¸</div>
            <p><strong>Click</strong> to select photo</p>
            <p style="margin-top:4px;font-size:11px;">Crop & rotate, then compress before upload</p>
          </div>
          <div class="img-editor" id="ph-editor">
            <div class="editor-toolbar">
              <span>EDIT:</span>
              <button class="nb nb-ghost nb-sm" onclick="phEd.rotate(-90)">â†º LEFT</button>
              <button class="nb nb-ghost nb-sm" onclick="phEd.rotate(90)">â†» RIGHT</button>
              <button class="nb nb-ghost nb-sm" id="ph-crop-btn" onclick="phEd.toggleCrop()">âœ‚ CROP</button>
              <button class="nb nb-yellow nb-sm" id="ph-apply-btn" style="display:none" onclick="phEd.applyCrop()">âœ… APPLY CROP</button>
              <button class="nb nb-ghost nb-sm" onclick="phEd.reset()">â†º RESET</button>
            </div>
            <div class="canvas-wrap" id="ph-canvas-wrap"><canvas id="ph-canvas" class="ec"></canvas></div>
            <div class="editor-footer">
              <span class="size-badge" id="ph-size"></span>
              <button class="nb nb-orange nb-sm" id="btn-compress-photo" style="display:none" onclick="compressPhoto()">âš¡ COMPRESS</button>
              <button class="nb nb-green nb-sm" id="btn-upload-photo" style="display:none" onclick="uploadPhoto()">â¬† UPLOAD PHOTO</button>
            </div>
          </div>
        </div>
        <div class="preview-box" id="ph-preview" onclick="openLightbox('photo')">
          <span>No photo selected</span>
          <div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>
        </div>
      </div>
    </div>
  </div>

  <!-- DOCUMENT -->
  <div class="reg-section">
    <div class="reg-sect-head">
      <span class="ico">ğŸªª</span>
      <div><h3>DOCUMENT / ID IMAGE</h3><p>Upload ID proof Â· Crop & rotate Â· Stored as Base64</p></div>
    </div>
    <div class="reg-sect-body">
      <div class="media-grid">
        <div>
          <div class="upload-zone" id="doc-zone">
            <input type="file" id="doc-file" accept="image/*" />
            <div class="uz-ico">ğŸªª</div>
            <p><strong>Click</strong> to select document image</p>
          </div>
          <div class="img-editor" id="doc-editor">
            <div class="editor-toolbar">
              <span>EDIT:</span>
              <button class="nb nb-ghost nb-sm" onclick="docEd.rotate(-90)">â†º LEFT</button>
              <button class="nb nb-ghost nb-sm" onclick="docEd.rotate(90)">â†» RIGHT</button>
              <button class="nb nb-ghost nb-sm" id="doc-crop-btn" onclick="docEd.toggleCrop()">âœ‚ CROP</button>
              <button class="nb nb-yellow nb-sm" id="doc-apply-btn" style="display:none" onclick="docEd.applyCrop()">âœ… APPLY</button>
              <button class="nb nb-ghost nb-sm" onclick="docEd.reset()">â†º RESET</button>
            </div>
            <div class="canvas-wrap" id="doc-canvas-wrap"><canvas id="doc-canvas" class="ec"></canvas></div>
            <div class="editor-footer">
              <span class="size-badge" id="doc-size"></span>
              <button class="nb nb-orange nb-sm" id="btn-compress-doc" style="display:none" onclick="compressDoc()">âš¡ COMPRESS</button>
              <button class="nb nb-green nb-sm" id="btn-upload-doc" style="display:none" onclick="uploadDoc()">â¬† UPLOAD DOC</button>
            </div>
            <!-- Person crop bar -->
            <div class="doc-crop-person-bar" id="doc-person-bar" style="display:none;">
              <span>ğŸ§‘â€ğŸ’¼</span>
              <button class="nb nb-orange nb-sm" onclick="detectAndCropPerson()">ğŸ” DETECT & CROP PERSON PHOTO</button>
              <p>Uses Gemini AI to find the person's face/photo in the doc and auto-fill the photo slot</p>
              <span id="crop-person-status"></span>
            </div>
          </div>
        </div>
        <div class="preview-box" id="doc-preview" onclick="openLightbox('doc')">
          <span>No document selected</span>
          <div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>
        </div>
      </div>
    </div>
  </div>

  <!-- SUBMIT -->
  <div class="submit-section">
    <h3>SUBMIT REGISTRATION</h3>
    <p>Required: ID Number, Sevak Name, DOB, Mobile, Gender, State</p>
    <button class="nb nb-yellow" id="btn-submit" onclick="submitForm()">ğŸš€ SUBMIT REGISTRATION</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PAGE: BULK REGISTER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="pg-bulk">

  <!-- SIDEBAR -->
  <div class="bk-sidebar">
    <div class="bk-sidebar-hd">
      PERSONS <span id="bk-badge" style="background:var(--yellow);color:#000;padding:1px 7px;border-radius:20px;margin-left:4px;">0</span>
    </div>
    <div class="bk-list" id="bk-list"></div>
    <div class="bk-sidebar-ft">
      <button class="nb nb-yellow nb-sm" style="width:100%;justify-content:center;" onclick="bkAdd()">ï¼‹ ADD PERSON</button>
      <button class="nb nb-black nb-sm" style="width:100%;justify-content:center;" onclick="document.getElementById('bk-photos-input').click()">ğŸ“¸ IMPORT PHOTOS</button>
      <input type="file" id="bk-photos-input" accept="image/*" multiple style="display:none" onchange="bkImportPhotos(this.files)">
      <button class="nb nb-ghost nb-sm" style="width:100%;justify-content:center;" onclick="bkClearAll()">âœ• CLEAR ALL</button>
    </div>
  </div>

  <!-- MAIN PANEL -->
  <div class="bk-panel" id="bk-panel">

    <!-- empty state -->
    <div class="bk-empty" id="bk-empty">
      <div class="ico">ğŸ‘¥</div>
      <h2>NO PERSONS YET</h2>
      <p>CLICK ï¼‹ ADD PERSON OR<br>ğŸ“¸ IMPORT PHOTOS TO BEGIN</p>
      <div style="display:flex;gap:10px;margin-top:6px;">
        <button class="nb nb-yellow" onclick="bkAdd()">ï¼‹ ADD PERSON</button>
        <button class="nb nb-black" onclick="document.getElementById('bk-photos-input').click()">ğŸ“¸ IMPORT PHOTOS</button>
      </div>
    </div>

    <!-- top nav bar (shown once persons exist) -->
    <div class="bk-topbar" id="bk-topbar" style="display:none;">
      <button class="bk-nav" id="bk-prev" onclick="bkNav(-1)" disabled>â—€ PREV</button>
      <span class="bk-counter" id="bk-counter">1 / 1</span>
      <button class="bk-nav" id="bk-next" onclick="bkNav(1)">NEXT â–¶</button>
      <span class="bk-person-lbl" id="bk-lbl"></span>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
        <span id="bk-save-status" style="font-family:'Space Mono',monospace;font-size:9px;"></span>
        <button class="nb nb-black nb-sm" onclick="bkSaveAll()">ğŸš€ SAVE ALL</button>
      </div>
    </div>

    <!-- progress + log (during save) -->
    <div class="bk-prog-wrap" id="bk-prog-wrap" style="display:none;">
      <div class="bk-prog-fill" id="bk-prog-fill" style="width:0%"><span id="bk-prog-txt">0%</span></div>
    </div>
    <div id="bk-log" style="font-family:'Space Mono',monospace;font-size:10px;max-height:120px;overflow-y:auto;padding:6px 20px;background:#f5f2ee;border-bottom:var(--b2);display:none;"></div>

    <!-- per-person forms injected here -->
    <div id="bk-forms"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EDIT/ADD MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="form-overlay">
  <div class="modal">
    <button class="btn-x" onclick="closeModal()">âœ•</button>
    <div class="modal-title"><span id="m-verb">ADD</span> <span class="hi">RECORD</span></div>
    <div class="mgrid">
      <div class="fld"><label>ID Number <span class="req">*</span></label><input id="f-idNumber" /></div>
      <div class="fld"><label>Code <span class="req">*</span></label><input id="f-code" /></div>
      <div class="fld"><label>Sevak Name</label><input id="f-sevakName" /></div>
      <div class="fld"><label>Surname</label><input id="f-surName" /></div>
      <div class="fld"><label>Father / Spouse Name</label><input id="f-fatherOrSpouseName" /></div>
      <div class="fld"><label>Date of Birth</label><input id="f-dob" type="date" /></div>
      <div class="fld"><label>Gender</label>
        <select id="f-gender"><option value="">Select</option><option>Male</option><option>Female</option><option>Other</option></select>
      </div>
      <div class="fld"><label>Mobile No</label><input id="f-mobileNo" type="tel" /></div>
      <div class="fld"><label>Email</label><input id="f-email" type="email" /></div>
      <div class="fld"><label>State</label><input id="f-state" /></div>
      <div class="fld"><label>District</label><input id="f-district" /></div>
      <div class="fld"><label>City</label><input id="f-city" /></div>
      <div class="fld"><label>Pincode</label><input id="f-pincode" /></div>
      <div class="fld mfull"><label>Street</label><input id="f-street" /></div>
      <div class="fld"><label>Door No</label><input id="f-doorNo" /></div>
      <div class="fld mfull">
        <label>Photo</label>
        <div class="photo-row">
          <div class="photo-thumb" id="m-photo-thumb">ğŸ“·</div>
          <div>
            <button class="nb nb-ghost nb-sm" type="button" onclick="document.getElementById('m-photo-input').click()">UPLOAD PHOTO</button>
            <input type="file" id="m-photo-input" accept="image/*" style="display:none" onchange="handleModalPhoto(event)" />
            <div style="font-family:'Space Mono',monospace;font-size:9px;color:#aaa;margin-top:4px;letter-spacing:1px;">JPG/PNG â€” STORED AS BASE64 â€” MAX 2MB</div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="nb nb-ghost" onclick="closeModal()">CANCEL</button>
      <button class="nb nb-black" onclick="saveRecord()">âš¡ SAVE RECORD</button>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="overlay" id="del-overlay">
  <div class="modal" style="max-width:420px;">
    <div class="modal-title">DELETE <span class="hi">RECORD?</span></div>
    <p style="font-size:15px;color:#555;margin-bottom:20px;line-height:1.6;">
      Permanently remove <strong id="del-name-lbl"></strong> from Supabase.<br/>This <strong>cannot be undone</strong>.
    </p>
    <div class="modal-footer">
      <button class="nb nb-ghost" onclick="closeDel()">CANCEL</button>
      <button class="nb nb-red" onclick="confirmDelete()">âœ• YES, DELETE</button>
    </div>
  </div>
</div>

<!-- COPY / MOVE / BULK MODAL (unified) -->
<div class="overlay" id="transfer-overlay">
  <div class="modal" style="max-width:500px;">
    <button class="btn-x" onclick="closeTransferModal()">âœ•</button>
    <div class="modal-title" id="transfer-title">MOVE TO <span class="hi">TABLE</span></div>
    <p style="font-size:14px;color:#555;margin-bottom:14px;line-height:1.7;" id="transfer-desc"></p>
    <div class="fld" style="margin-bottom:16px;">
      <label>Target Table Name <span class="req">*</span></label>
      <input id="transfer-target" placeholder="e.g. archive, sevaks_2025" style="width:100%;" />
    </div>
    <!-- bulk progress log -->
    <div id="transfer-prog-wrap" style="display:none;margin-bottom:10px;">
      <div style="background:#e8e4dc;border:var(--b2);height:16px;overflow:hidden;margin-bottom:6px;">
        <div id="transfer-prog-fill" style="height:100%;background:var(--green);width:0%;transition:width .3s;"></div>
      </div>
      <div id="transfer-log" style="font-family:'Space Mono',monospace;font-size:10px;max-height:130px;overflow-y:auto;background:#f5f2ee;border:var(--b2);padding:6px 10px;"></div>
    </div>
    <div id="transfer-status" style="font-family:'Space Mono',monospace;font-size:11px;min-height:20px;margin-bottom:10px;"></div>
    <div class="modal-footer">
      <button class="nb nb-ghost" onclick="closeTransferModal()">CANCEL</button>
      <button class="nb nb-blue" id="transfer-btn" onclick="runTransfer()">GO</button>
    </div>
  </div>
</div>

<!-- BULK CODE REASSIGN MODAL -->
<div class="overlay" id="reassign-overlay">
  <div class="modal" style="max-width:520px;">
    <button class="btn-x" onclick="closeReassignModal()">âœ•</button>
    <div class="modal-title">ğŸ· REASSIGN <span class="hi">CODE</span></div>

    <!-- summary of selected records' current codes -->
    <div id="reassign-summary" style="margin-bottom:16px;padding:12px 14px;background:var(--off);border:var(--b2);font-family:'Space Mono',monospace;font-size:11px;line-height:2;"></div>

    <!-- new code input -->
    <div class="fld" style="margin-bottom:8px;">
      <label>New Code <span class="req">*</span></label>
      <input id="reassign-new-code" placeholder="e.g. BATCH-2025, ZONE-A" style="width:100%;font-family:'Space Mono',monospace;font-size:14px;letter-spacing:1px;" oninput="updateReassignPreview()" />
    </div>

    <!-- live preview -->
    <div id="reassign-preview" style="display:none;margin-bottom:14px;padding:10px 14px;border:2px solid var(--green);background:#f0fff7;font-family:'Space Mono',monospace;font-size:11px;line-height:1.8;"></div>

    <!-- progress + log (shown during save) -->
    <div id="reassign-prog-wrap" style="display:none;margin-bottom:10px;">
      <div style="background:#e8e4dc;border:var(--b2);height:16px;overflow:hidden;margin-bottom:6px;">
        <div id="reassign-prog-fill" style="height:100%;background:var(--green);width:0%;transition:width .25s;display:flex;align-items:center;padding-left:8px;">
          <span id="reassign-prog-txt" style="font-family:'Space Mono',monospace;font-size:9px;color:#fff;white-space:nowrap;"></span>
        </div>
      </div>
      <div id="reassign-log" style="font-family:'Space Mono',monospace;font-size:10px;max-height:140px;overflow-y:auto;background:#f5f2ee;border:var(--b2);padding:6px 10px;"></div>
    </div>

    <div id="reassign-status" style="font-family:'Space Mono',monospace;font-size:11px;min-height:18px;margin-bottom:10px;"></div>

    <div class="modal-footer">
      <button class="nb nb-ghost" onclick="closeReassignModal()">CANCEL</button>
      <button class="nb nb-green" id="reassign-btn" onclick="runReassign()">ğŸ· APPLY TO ALL</button>
    </div>
  </div>
</div>

<!-- AI PROGRESS BANNER -->
<div id="ai-progress-banner">
  <div id="ai-progress-inner">
    <div id="ai-progress-icon">ğŸ¤–</div>
    <div id="ai-progress-text">AI IS WORKINGâ€¦</div>
    <div id="ai-progress-step"></div>
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>
  <div id="ai-progress-bar-track">
    <div id="ai-progress-bar-fill"></div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <img id="lb-img" src="" alt="Full size" />
</div>

<!-- TOAST -->
<div id="toast"></div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let SB_URL='', SB_KEY='', TABLE='customers';
let allRecords=[], displayRecords=[];
let curPage=1; const PG=15;
let editRowId=null, delRowId=null, activeRecord=null;
let mNewPhoto=''; // modal photo

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  if(tab==='list')     { document.getElementById('pg-list').classList.add('active'); document.getElementById('search-bar').style.display=''; document.getElementById('ai-drawer').classList.remove('open'); }
  if(tab==='detail')   { document.getElementById('pg-detail').classList.add('active'); document.getElementById('search-bar').style.display='none'; document.getElementById('ai-drawer').classList.remove('open'); }
  if(tab==='register') { document.getElementById('pg-register').classList.add('active'); document.getElementById('search-bar').style.display='none'; document.getElementById('ai-drawer').classList.remove('open'); }
  if(tab==='bulk')     { document.getElementById('pg-bulk').classList.add('active'); document.getElementById('search-bar').style.display='none'; document.getElementById('ai-drawer').classList.remove('open'); }
  window.scrollTo({top:0,behavior:'smooth'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function supa(path, opts={}) {
  const url = SB_URL+'/rest/v1/'+path;
  const h = {
    'apikey': SB_KEY,
    'Authorization': 'Bearer '+SB_KEY,
    'Content-Type': 'application/json',
    ...(opts.headers||{})
  };
  if(opts.method==='PATCH'||opts.method==='POST') h['Prefer']='return=representation';
  const res = await fetch(url, {...opts, headers:h});
  if(!res.ok) throw new Error(await res.text()||'HTTP '+res.status);
  const t = await res.text();
  return t ? JSON.parse(t) : [];
}

async function connect() {
  SB_URL = document.getElementById('cfg-url').value.trim().replace(/\/+$/,'');
  SB_KEY = document.getElementById('cfg-key').value.trim();
  TABLE  = document.getElementById('cfg-table').value.trim()||'customers';
  document.getElementById('hdr-table').textContent = TABLE;
  const st = document.getElementById('conn-status');
  st.textContent='â³ connectingâ€¦'; st.style.color='#FFE500';
  try {
    await fetchAll();
    st.textContent='âœ“ connected'; st.style.color='#00C16A';
    toast('CONNECTED TO SUPABASE','ok');
  } catch(e) {
    st.textContent='âœ— failed'; st.style.color='#E63030';
    toast('CONNECT FAILED: '+e.message,'err');
  }
}

// Known columns in this table â€” auto-detected on connect
let tableColumns = new Set();

function filterToColumns(data) {
  if (tableColumns.size === 0) return data;
  const out = {};
  for (const k of Object.keys(data)) {
    if (tableColumns.has(k)) out[k] = data[k];
  }
  return out;
}

async function fetchAll() {
  // Detect columns from first row
  const probe = await supa(`${TABLE}?select=*&limit=1`);
  if (Array.isArray(probe) && probe.length > 0) {
    tableColumns = new Set(Object.keys(probe[0]));
    showColumnStatus();
  }
  const all = await supa(`${TABLE}?select=*&order=idNumber.asc`);
  allRecords = Array.isArray(all) ? all : [];
  buildStateFilter();
  buildCodeFilter();
  updateStats();
  applyFilters();
  document.getElementById('tc-records').textContent = allRecords.length;
}

function showColumnStatus() {
  const allPossible = ['idNumber','code','sevakName','surName','fatherOrSpouseName','dob','mobileNo','email','gender','state','district','city','street','doorNo','pincode','photoBase64'];
  const missing = allPossible.filter(c => !tableColumns.has(c));
  const st = document.getElementById('conn-status');
  if (missing.length > 0) {
    st.innerHTML = `<span style="color:#00C16A">âœ“ connected</span> &nbsp;<span style="color:#FF6B00;font-size:9px;">âš  SKIPPING: ${missing.join(', ')}</span>`;
  }
}

document.getElementById('btn-connect').onclick = connect;
document.getElementById('cfg-table').oninput = function(){
  document.getElementById('hdr-table').textContent = this.value||'customers';
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS / SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('btn-ai-toggle').onclick = () => document.getElementById('ai-drawer').classList.toggle('open');
document.getElementById('ai-q').onkeydown = e=>{ if(e.key==='Enter') runAi(); };

function quickSearch(){ applyFilters(); }

function applyFilters(){
  const q  = (document.getElementById('search-input').value||'').toLowerCase();
  const cf = document.getElementById('flt-code').value;
  const gf = document.getElementById('flt-gender').value;
  const sf = document.getElementById('flt-state').value;
  displayRecords = allRecords.filter(r=>{
    const mq = !q||['idNumber','code','sevakName','surName','mobileNo','city','state','email','district','doorNo','pincode']
      .some(f=>String(r[f]||'').toLowerCase().includes(q));
    return mq && (!cf||r.code===cf) && (!gf||r.gender===gf) && (!sf||r.state===sf);
  });
  curPage=1;
  document.getElementById('s-shown').textContent=displayRecords.length;
  renderTable();
}

function buildStateFilter(){
  const states=[...new Set(allRecords.map(r=>r.state).filter(Boolean))].sort();
  const sel=document.getElementById('flt-state');
  sel.innerHTML='<option value="">ALL STATES</option>'+states.map(s=>`<option>${s}</option>`).join('');
}

function buildCodeFilter(){
  const codes=[...new Set(allRecords.map(r=>r.code).filter(Boolean))].sort();
  const sel=document.getElementById('flt-code');
  sel.innerHTML='<option value="">ALL CODES</option>'+codes.map(c=>`<option>${c}</option>`).join('');
}

function updateStats(){
  document.getElementById('s-total').textContent   = allRecords.length;
  document.getElementById('s-states').textContent  = new Set(allRecords.map(r=>r.state).filter(Boolean)).size;
  document.getElementById('s-male').textContent    = allRecords.filter(r=>r.gender==='Male').length;
  document.getElementById('s-female').textContent  = allRecords.filter(r=>r.gender==='Female').length;
  document.getElementById('s-shown').textContent   = displayRecords.length||allRecords.length;
  document.getElementById('tc-records').textContent= allRecords.length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI FILTER (Claude API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runAi(){
  const q=document.getElementById('ai-q').value.trim();
  if(!q||!SB_URL){if(!SB_URL)toast('CONNECT FIRST','err');return;}
  document.getElementById('ai-thinking').classList.add('on');
  document.getElementById('ai-badge').classList.remove('on');
  const fields='idNumber,code,sevakName,surName,fatherOrSpouseName,dob,mobileNo,email,gender,state,district,city,street,doorNo,pincode';
  const sample=JSON.stringify(allRecords.slice(0,4).map(r=>{const o={};fields.split(',').forEach(f=>o[f]=r[f]);return o;}));
  const prompt=`You are a JSON-only filter assistant. Fields: ${fields}. User query: "${q}". Sample: ${sample}.
Reply ONLY with: {"description":"label","filters":[{"field":"f","op":"eq|ilike|gt|lt","value":"v"}]}. ilike needs % wildcards.`;
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:400,messages:[{role:'user',content:prompt}]})
    });
    const ai=await res.json();
    let txt=(ai.content||[]).map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
    const result=JSON.parse(txt);
    let filtered=[...allRecords];
    for(const f of(result.filters||[])){
      filtered=filtered.filter(r=>{
        const v=String(r[f.field]||'').toLowerCase();
        const fv=String(f.value).replace(/%/g,'').toLowerCase();
        if(f.op==='eq') return v===fv;
        if(f.op==='ilike') return v.includes(fv);
        if(f.op==='gt') return parseFloat(r[f.field])>parseFloat(f.value);
        if(f.op==='lt') return parseFloat(r[f.field])<parseFloat(f.value);
        return true;
      });
    }
    displayRecords=filtered; curPage=1; renderTable();
    document.getElementById('ai-badge-txt').textContent=`${result.description} (${filtered.length})`;
    document.getElementById('ai-badge').classList.add('on');
    document.getElementById('s-shown').textContent=filtered.length;
  }catch(e){toast('AI ERROR: '+e.message,'err');}
  document.getElementById('ai-thinking').classList.remove('on');
}

function clearAi(){
  document.getElementById('ai-badge').classList.remove('on');
  document.getElementById('ai-q').value='';
  applyFilters();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABLE RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTable(){
  const tbody=document.getElementById('tbody');
  const empty=document.getElementById('empty-state');
  const total=displayRecords.length;
  const pages=Math.max(1,Math.ceil(total/PG));
  if(curPage>pages) curPage=pages;
  const slice=displayRecords.slice((curPage-1)*PG,curPage*PG);
  if(!slice.length){tbody.innerHTML='';empty.style.display='block';document.getElementById('pag-btns').innerHTML='';document.getElementById('pag-info').textContent='';return;}
  empty.style.display='none';
  tbody.innerHTML='';
  slice.forEach(r=>{
    const name=[r.sevakName,r.surName].filter(Boolean).join(' ')||'â€”';
    const init=(r.sevakName||'?')[0].toUpperCase();
    const src=r.photoBase64?(r.photoBase64.startsWith('data:')?r.photoBase64:'data:image/jpeg;base64,'+r.photoBase64):null;
    const av=src?`<div class="av"><img src="${src}" /></div>`:`<div class="av"><span class="av-init">${init}</span></div>`;
    const gc=r.gender==='Male'?'gm':r.gender==='Female'?'gf':'go';
    const isSelected = selectedIds.has(r.id);
    const tr=document.createElement('tr');
    if (isSelected) tr.classList.add('selected-row');
    tr.innerHTML=`
      <td class="chk-col" onclick="event.stopPropagation()">
        <input type="checkbox" class="row-chk" data-rid="${r.id}" ${isSelected?'checked':''} onchange="toggleRowSelect(${r.id}, this.checked)" />
      </td>
      <td>${av}</td>
      <td><span class="id-tag">${r.idNumber||'â€”'}</span></td>
      <td class="code-cell-td" data-id="${r.id}" data-code="${(r.code||'').replace(/"/g,'&quot;')}">
        <span class="code-display nb-sm" style="background:var(--black);color:var(--yellow);font-family:'Space Mono',monospace;font-size:10px;padding:3px 8px;cursor:pointer;" title="Click to edit code">${r.code||'â€”'}</span>
      </td>
      <td><div class="name-cell"><strong>${name}</strong><span>${r.email||''}</span></div></td>
      <td style="white-space:nowrap;">${r.dob||'â€”'}</td>
      <td><span class="gpill ${gc}">${r.gender||'â€”'}</span></td>
      <td>${r.mobileNo||'â€”'}</td>
      <td><div class="loc-cell"><div>${r.state||'â€”'}</div><div>${r.city||''}</div></div></td>
      <td class="arr">â€º</td>`;
    // row click opens detail (but not if clicking checkbox or code cell)
    tr.onclick=(e)=>{ if(e.target.closest('.chk-col')||e.target.closest('.code-cell-td')) return; openDetail(r); };
    // inline code editing
    const codeTd = tr.querySelector('.code-cell-td');
    codeTd.onclick = (e) => { e.stopPropagation(); startInlineCodeEdit(codeTd, r); };
    tbody.appendChild(tr);
  });
  document.getElementById('pag-info').textContent=`${(curPage-1)*PG+1}â€“${Math.min(curPage*PG,total)} OF ${total}`;
  renderPag(pages);
  updateBulkBar();
}

function renderPag(pages){
  const c=document.getElementById('pag-btns');
  if(pages<=1){c.innerHTML='';return;}
  let h=`<button class="pg" onclick="goPage(${curPage-1})" ${curPage===1?'disabled':''}>â€¹</button>`;
  for(let i=1;i<=pages;i++){
    if(pages>7&&Math.abs(i-curPage)>2&&i!==1&&i!==pages){if(i===2||i===pages-1)h+='<span style="padding:0 4px;color:#aaa;">â€¦</span>';continue;}
    h+=`<button class="pg ${i===curPage?'on':''}" onclick="goPage(${i})">${i}</button>`;
  }
  h+=`<button class="pg" onclick="goPage(${curPage+1})" ${curPage===pages?'disabled':''}>â€º</button>`;
  c.innerHTML=h;
}

function goPage(n){
  const pages=Math.ceil(displayRecords.length/PG);
  if(n<1||n>pages)return;
  curPage=n; renderTable();
  document.getElementById('pg-list').scrollIntoView({behavior:'smooth'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDetail(r){
  activeRecord=r;
  switchTab('detail');
  const name=[r.sevakName,r.surName].filter(Boolean).join(' ')||'â€”';
  document.getElementById('d-name').textContent=name;
  document.getElementById('d-sub').textContent=r.fatherOrSpouseName?'S/o or W/o '+r.fatherOrSpouseName:'';
  const av=document.getElementById('d-avatar');
  const src=r.photoBase64?(r.photoBase64.startsWith('data:')?r.photoBase64:'data:image/jpeg;base64,'+r.photoBase64):null;
  av.innerHTML=src?`<img src="${src}" alt="${name}"/>`:`<span class="d-av-init">${(r.sevakName||'?')[0].toUpperCase()}</span>`;
  const gc=r.gender==='Male'?'gm':r.gender==='Female'?'gf':'go';
  document.getElementById('d-pills').innerHTML=[
    r.gender?`<span class="gpill ${gc}">${r.gender}</span>`:'',
    r.idNumber?`<span class="id-tag">${r.idNumber}</span>`:'',
    r.state?`<span style="font-family:'Space Mono',monospace;font-size:10px;border:2px solid #444;padding:3px 9px;color:#aaa;">ğŸ“ ${r.state}</span>`:''
  ].filter(Boolean).join('');
  const set=(id,val)=>{const el=document.getElementById(id);if(!el)return;if(val){el.textContent=val;el.className='d-val'+(id==='d-idNumber'?' code':'');}else{el.textContent='Not provided';el.className='d-val empty';}};
  ['idNumber','code','sevakName','surName','fatherOrSpouseName','dob','gender','mobileNo','email','doorNo','street','city','district','state','pincode'].forEach(f=>set('d-'+f,r[f]));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADD / EDIT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAdd(){
  editRowId=null; mNewPhoto='';
  document.getElementById('m-verb').textContent='ADD';
  clearModalForm();
  document.getElementById('form-overlay').classList.add('open');
}
function openEdit(){
  const r=activeRecord; if(!r)return;
  editRowId=r.id!==undefined?r.id:null; mNewPhoto=r.photoBase64||'';
  document.getElementById('m-verb').textContent='EDIT';
  ['idNumber','code','sevakName','surName','fatherOrSpouseName','dob','mobileNo','email','gender','state','district','city','street','doorNo','pincode'].forEach(f=>{
    const el=document.getElementById('f-'+f);if(el)el.value=r[f]||'';
  });
  const pt=document.getElementById('m-photo-thumb');
  if(mNewPhoto){const s=mNewPhoto.startsWith('data:')?mNewPhoto:'data:image/jpeg;base64,'+mNewPhoto;pt.innerHTML=`<img src="${s}"/>`;}
  else pt.innerHTML='ğŸ“·';
  document.getElementById('form-overlay').classList.add('open');
}
function clearModalForm(){
  ['idNumber','code','sevakName','surName','fatherOrSpouseName','dob','mobileNo','email','gender','state','district','city','street','doorNo','pincode'].forEach(f=>{
    const el=document.getElementById('f-'+f);if(el)el.value='';
  });
  document.getElementById('m-photo-thumb').innerHTML='ğŸ“·';
  mNewPhoto='';
}
function closeModal(){ document.getElementById('form-overlay').classList.remove('open'); }

function handleModalPhoto(evt){
  const file=evt.target.files[0];if(!file)return;
  if(file.size>2*1024*1024){toast('MAX 2MB','err');return;}
  const rdr=new FileReader();
  rdr.onload=e=>{mNewPhoto=e.target.result;document.getElementById('m-photo-thumb').innerHTML=`<img src="${mNewPhoto}"/>`;};
  rdr.readAsDataURL(file); evt.target.value='';
}

async function saveRecord(){
  const fields=['idNumber','code','sevakName','surName','fatherOrSpouseName','dob','mobileNo','email','gender','state','district','city','street','doorNo','pincode'];
  const raw={};
  fields.forEach(f=>{const el=document.getElementById('f-'+f);if(el&&el.value.trim())raw[f]=el.value.trim();});
  if(mNewPhoto) raw.photoBase64=mNewPhoto;
  if(!raw.idNumber){toast('ID NUMBER IS REQUIRED','err');return;}
  if(!SB_URL){toast('CONNECT TO SUPABASE FIRST','err');return;}
  const data=filterToColumns(raw);
  try{
    if(editRowId!==null&&editRowId!==undefined){
      const updated=await supa(`${TABLE}?id=eq.${editRowId}`,{method:'PATCH',body:JSON.stringify(data)});
      const fresh=Array.isArray(updated)&&updated.length>0?updated[0]:{...activeRecord,...data};
      activeRecord=fresh;
      const idx=allRecords.findIndex(r=>r.id===editRowId);
      if(idx>=0)allRecords[idx]=fresh;
      toast('RECORD UPDATED!','ok');
      closeModal();
      openDetail(fresh);
      updateStats();
    }else{
      await supa(TABLE,{method:'POST',body:JSON.stringify(data)});
      toast('RECORD ADDED!','ok');
      closeModal();
      await fetchAll();
      switchTab('list');
    }
  }catch(e){toast('ERROR: '+e.message,'err');console.error(e);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DELETE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDel(){
  const r=activeRecord;if(!r)return;
  delRowId=r.id!==undefined?r.id:null;
  document.getElementById('del-name-lbl').textContent=[r.sevakName,r.surName].filter(Boolean).join(' ')||r.idNumber;
  document.getElementById('del-overlay').classList.add('open');
}
function closeDel(){ document.getElementById('del-overlay').classList.remove('open'); }
async function confirmDelete(){
  if(delRowId===null||delRowId===undefined){toast('CANNOT IDENTIFY RECORD','err');return;}
  try{
    await supa(`${TABLE}?id=eq.${delRowId}`,{method:'DELETE'});
    toast('RECORD DELETED','ok');
    closeDel();
    allRecords=allRecords.filter(r=>r.id!==delRowId);
    updateStats(); applyFilters(); switchTab('list');
  }catch(e){toast('DELETE FAILED: '+e.message,'err');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERLAY BACKDROP CLOSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.getElementById('form-overlay').onclick=e=>{if(e.target===e.currentTarget)closeModal();};
document.getElementById('del-overlay').onclick=e=>{if(e.target===e.currentTarget)closeDel();};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg,type=''){
  const el=document.getElementById('toast');
  el.textContent=msg; el.className='show '+type;
  clearTimeout(el._t); el._t=setTimeout(()=>el.className='',3400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS (image compression)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtKB(b){ return (b/1024).toFixed(1)+' KB'; }
function dataUrlToBlob(d){ const[h,data]=d.split(','),mime=h.match(/:(.*?);/)[1],bin=atob(data),arr=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)arr[i]=bin.charCodeAt(i);return new Blob([arr],{type:mime}); }

async function compressBlob(input, maxKB=30){
  const blob=input instanceof Blob?input:dataUrlToBlob(input);
  return new Promise(res=>{
    const img=new Image(), objUrl=URL.createObjectURL(blob);
    img.onload=()=>{
      const MAX=maxKB*1024, cv=document.createElement('canvas');
      let quality=0.88, scale=1;
      function go(){
        let w=img.width*scale, h=img.height*scale;
        const mx=900; if(w>mx||h>mx){const r=Math.min(mx/w,mx/h);w*=r;h*=r;}
        cv.width=Math.round(w); cv.height=Math.round(h);
        cv.getContext('2d').drawImage(img,0,0,cv.width,cv.height);
        const b64=cv.toDataURL('image/jpeg',quality);
        const bytes=Math.round((b64.length-'data:image/jpeg;base64,'.length)*3/4);
        if(bytes<=MAX||quality<0.07){URL.revokeObjectURL(objUrl);res({base64:b64,bytes});}
        else{if(quality>0.16)quality-=0.08;else scale*=0.82;go();}
      }
      go();
    };
    img.src=objUrl;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMAGE EDITOR CLASS  (fixed coordinate system)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class ImageEditor {
  constructor({ canvasId, wrapId, cropBtnId, applyBtnId, sizeBadgeId, onCompressed }) {
    this.displayCanvas = document.getElementById(canvasId);
    this.wrap          = document.getElementById(wrapId);
    this.cropBtnEl     = document.getElementById(cropBtnId);
    this.applyBtnEl    = document.getElementById(applyBtnId);
    this.sizeBadgeEl   = document.getElementById(sizeBadgeId);
    this.onCompressed  = onCompressed;
    this.onRawUpdate   = onCompressed; // called on every edit with raw dataUrl
    this.dCtx          = this.displayCanvas.getContext('2d');

    // source canvas holds the FULL working image at true resolution
    this.srcCanvas  = document.createElement('canvas');
    this.sCtx       = this.srcCanvas.getContext('2d');

    this.origDataUrl   = null;
    this.cropMode      = false;
    this.sel           = { active: false, sx: 0, sy: 0, ex: 0, ey: 0 };
    this._bind();
  }

  // â”€â”€ coordinate helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Returns the display-canvas pixel coordinates from a mouse/touch event.
  // We keep everything in display-canvas space for mouse interaction.
  _pos(e) {
    const r  = this.displayCanvas.getBoundingClientRect();
    const pt = e.touches ? e.touches[0] : e;
    // Map from CSS pixels â†’ canvas pixels
    const scaleX = this.displayCanvas.width  / r.width;
    const scaleY = this.displayCanvas.height / r.height;
    return {
      x: Math.round((pt.clientX - r.left) * scaleX),
      y: Math.round((pt.clientY - r.top)  * scaleY)
    };
  }

  // â”€â”€ bind mouse / touch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _bind() {
    const c = this.displayCanvas;
    c.addEventListener('mousedown',  e => { if (!this.cropMode) return; e.preventDefault(); const p = this._pos(e); this.sel = { active: true, sx: p.x, sy: p.y, ex: p.x, ey: p.y }; });
    c.addEventListener('mousemove',  e => { if (!this.cropMode || !this.sel.active) return; const p = this._pos(e); this.sel.ex = p.x; this.sel.ey = p.y; this._drawOverlay(); });
    c.addEventListener('mouseup',    ()  => { if (this.cropMode) this.sel.active = false; });
    c.addEventListener('mouseleave', ()  => { if (this.cropMode) this.sel.active = false; });
    c.addEventListener('touchstart', e => { if (!this.cropMode) return; e.preventDefault(); const p = this._pos(e); this.sel = { active: true, sx: p.x, sy: p.y, ex: p.x, ey: p.y }; }, { passive: false });
    c.addEventListener('touchmove',  e => { if (!this.cropMode || !this.sel.active) return; e.preventDefault(); const p = this._pos(e); this.sel.ex = p.x; this.sel.ey = p.y; this._drawOverlay(); }, { passive: false });
    c.addEventListener('touchend',   ()  => { if (this.cropMode) this.sel.active = false; });
  }

  // â”€â”€ draw helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Render srcCanvas â†’ displayCanvas (scaled to fit wrap width)
  _renderDisplay() {
    const wrapW = this.wrap.clientWidth || 500;
    const maxW  = wrapW - 4;
    const scale = Math.min(1, maxW / this.srcCanvas.width);
    this.displayCanvas.width  = Math.round(this.srcCanvas.width  * scale);
    this.displayCanvas.height = Math.round(this.srcCanvas.height * scale);
    this.dCtx.drawImage(this.srcCanvas, 0, 0, this.displayCanvas.width, this.displayCanvas.height);
  }

  // Redraw clean image onto display canvas (no overlay)
  _drawClean() {
    this.dCtx.drawImage(this.srcCanvas, 0, 0, this.displayCanvas.width, this.displayCanvas.height);
  }

  // Draw selection overlay on display canvas (coords are display-canvas pixels)
  _drawOverlay() {
    this._drawClean();
    const { sx, sy, ex, ey } = this.sel;
    const rx = Math.min(sx, ex), ry = Math.min(sy, ey);
    const rw = Math.abs(ex - sx), rh = Math.abs(ey - sy);
    if (rw < 1 || rh < 1) return;

    // dim everything outside selection
    this.dCtx.save();
    this.dCtx.fillStyle = 'rgba(0,0,0,0.52)';
    this.dCtx.fillRect(0, 0, this.displayCanvas.width, this.displayCanvas.height);
    // punch out the selected region â€” draw clean image into it
    this.dCtx.drawImage(
      this.srcCanvas,
      // src: map display crop rect back to src coords
      Math.round(rx * this.srcCanvas.width  / this.displayCanvas.width),
      Math.round(ry * this.srcCanvas.height / this.displayCanvas.height),
      Math.round(rw * this.srcCanvas.width  / this.displayCanvas.width),
      Math.round(rh * this.srcCanvas.height / this.displayCanvas.height),
      // dst: display rect
      rx, ry, rw, rh
    );
    // border
    this.dCtx.strokeStyle = '#FFE500';
    this.dCtx.lineWidth   = 2;
    this.dCtx.setLineDash([6, 3]);
    this.dCtx.strokeRect(rx + 1, ry + 1, rw - 2, rh - 2);
    this.dCtx.setLineDash([]);
    // corner handles
    this.dCtx.fillStyle = '#FFE500';
    [[rx, ry], [rx + rw, ry], [rx, ry + rh], [rx + rw, ry + rh]]
      .forEach(([x, y]) => this.dCtx.fillRect(x - 5, y - 5, 10, 10));
    this.dCtx.restore();
  }

  // â”€â”€ load an image dataUrl into srcCanvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _loadDataUrl(dataUrl) {
    return new Promise(resolve => {
      const img = new Image();
      img.onload = () => {
        this.srcCanvas.width  = img.naturalWidth;
        this.srcCanvas.height = img.naturalHeight;
        this.sCtx.drawImage(img, 0, 0);
        this._renderDisplay();
        resolve();
      };
      img.src = dataUrl;
    });
  }

  // â”€â”€ public API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async load(dataUrl) {
    this.origDataUrl = dataUrl;
    this.cropMode    = false;
    this.sel         = { active: false, sx: 0, sy: 0, ex: 0, ey: 0 };
    await this._loadDataUrl(dataUrl);
    await this._updSize();
    this._cropUI(false);
  }

  _cropUI(on) {
    if (this.cropBtnEl) {
      this.cropBtnEl.textContent = on ? 'âœ• EXIT CROP' : 'âœ‚ CROP';
      this.displayCanvas.classList.toggle('crop', on);
    }
    if (this.applyBtnEl) this.applyBtnEl.style.display = on ? 'inline-flex' : 'none';
  }

  toggleCrop() {
    this.cropMode = !this.cropMode;
    if (!this.cropMode) {
      this.sel = { active: false, sx: 0, sy: 0, ex: 0, ey: 0 };
      this._drawClean();
    }
    this._cropUI(this.cropMode);
  }

  async applyCrop() {
    const { sx, sy, ex, ey } = this.sel;
    const rx = Math.min(sx, ex), ry = Math.min(sy, ey);
    const rw = Math.abs(ex - sx), rh = Math.abs(ey - sy);
    if (rw < 5 || rh < 5) { toast('DRAW A CROP AREA FIRST', 'err'); return; }

    // Map display-canvas crop rect â†’ srcCanvas coordinates
    const scaleX = this.srcCanvas.width  / this.displayCanvas.width;
    const scaleY = this.srcCanvas.height / this.displayCanvas.height;
    const srcX = Math.round(rx * scaleX);
    const srcY = Math.round(ry * scaleY);
    const srcW = Math.round(rw * scaleX);
    const srcH = Math.round(rh * scaleY);

    // Create new srcCanvas with just the cropped region (full resolution)
    const cropped = document.createElement('canvas');
    cropped.width  = srcW;
    cropped.height = srcH;
    cropped.getContext('2d').drawImage(this.srcCanvas, srcX, srcY, srcW, srcH, 0, 0, srcW, srcH);

    // Reload into editor
    const croppedUrl = cropped.toDataURL('image/jpeg', 0.95);
    this.cropMode = false;
    this.sel      = { active: false, sx: 0, sy: 0, ex: 0, ey: 0 };
    this._cropUI(false);
    await this._loadDataUrl(croppedUrl);
    await this._updSize();
    toast('CROP APPLIED', 'ok');
  }

  async rotate(deg) {
    const sw = this.srcCanvas.width, sh = this.srcCanvas.height;
    const ow = Math.abs(deg) === 90 ? sh : sw;
    const oh = Math.abs(deg) === 90 ? sw : sh;
    const tmp = document.createElement('canvas');
    tmp.width = ow; tmp.height = oh;
    const ctx = tmp.getContext('2d');
    ctx.translate(ow / 2, oh / 2);
    ctx.rotate(deg * Math.PI / 180);
    ctx.drawImage(this.srcCanvas, -sw / 2, -sh / 2);
    await this._loadDataUrl(tmp.toDataURL('image/jpeg', 0.95));
    await this._updSize();
  }

  async reset() {
    if (this.origDataUrl) await this.load(this.origDataUrl);
    toast('IMAGE RESET', 'inf');
  }

  async _updSize() {
    // Show the raw uncompressed size of what's currently in srcCanvas
    const dataUrl = this.srcCanvas.toDataURL('image/jpeg', 0.92);
    const bytes = Math.round((dataUrl.length - 'data:image/jpeg;base64,'.length) * 3 / 4);
    if (this.sizeBadgeEl) this.sizeBadgeEl.textContent = fmtKB(bytes) + ' (raw)';
    // Store raw dataUrl for upload/use â€” onCompressed only called explicitly
    if (this.onRawUpdate) this.onRawUpdate(dataUrl, bytes);
  }

  // Returns the current full-resolution image as a dataUrl
  getDataUrl() { return this.srcCanvas.toDataURL('image/jpeg', 0.92); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI IMAGE EDITOR (OCR)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let aiEd=null;
function initAiEditor(dataUrl){
  document.getElementById('ai-editor').classList.add('show');
  if(!aiEd)aiEd=new ImageEditor({canvasId:'ai-canvas',wrapId:'ai-canvas-wrap',cropBtnId:'ai-crop-btn',applyBtnId:'ai-apply-btn',sizeBadgeId:'ai-size'});
  aiEd.load(dataUrl);
}
document.getElementById('ai-file').onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>initAiEditor(ev.target.result);r.readAsDataURL(f);};
['dragover','dragleave','drop'].forEach(ev=>document.getElementById('ai-zone').addEventListener(ev,e=>{
  e.preventDefault();document.getElementById('ai-zone').classList.toggle('drag',ev==='dragover');
  if(ev==='drop'){const f=e.dataTransfer.files[0];if(f){const r=new FileReader();r.onload=ev2=>initAiEditor(ev2.target.result);r.readAsDataURL(f);}}
}));

async function runOcr(){
  const gemKey=document.getElementById('cfg-gemini').value.trim();
  if(!gemKey){toast('ENTER GEMINI API KEY IN CONFIG','err');return;}
  if(!aiEd){toast('UPLOAD A FORM IMAGE FIRST','err');return;}
  const sEl=document.getElementById('ocr-status');
  sEl.style.display='flex'; sEl.className='ai-status proc';
  sEl.innerHTML='<div class="spinner"></div><span>Gemini is reading the handwritingâ€¦</span>';
  document.getElementById('btn-ocr').disabled=true;
  aiProgressAnim('GEMINI OCR â€” READING HANDWRITINGâ€¦', 'ğŸ”', 12000);
  try{
    const b64=aiEd.getDataUrl().split(',')[1];
    const payload={contents:[{parts:[
      {inline_data:{mime_type:'image/jpeg',data:b64}},
      {text:`You are a precise OCR assistant for handwritten Indian registration forms.
Extract ONLY these fields. Return ONLY a valid JSON object (null for unreadable):
{"idNumber":null,"code":null,"sevakName":null,"surName":null,"fatherOrSpouseName":null,"dob":null,"mobileNo":null,"email":null,"gender":null,"state":null,"district":null,"city":null,"street":null,"doorNo":null,"pincode":null}
Rules: dob in DD/MM/YYYY, gender must be "Male"/"Female"/"Other". NO markdown, NO explanation.`}
    ]}],generationConfig:{temperature:0.05,maxOutputTokens:2048}};
    const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${gemKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!res.ok){const e=await res.json();throw new Error(e.error?.message||'Gemini error '+res.status);}
    const data=await res.json();
    const text=(data.candidates?.[0]?.content?.parts||[]).map(p=>p.text||'').join('').trim();
    if(!text) throw new Error('Gemini returned empty response');
    let clean=text.replace(/^```(?:json)?\s*/i,'').replace(/\s*```\s*$/i,'').trim();
    let fields; try{fields=JSON.parse(clean);}catch(_){const m=clean.match(/\{[\s\S]*\}/);if(!m)throw new Error('No JSON in Gemini response');fields=JSON.parse(m[0]);}
    let filled=0;
    Object.entries(fields).forEach(([key,val])=>{
      const el=document.getElementById('r-'+key);if(!el||!val||val==='null')return;
      if(key==='gender'&&el.tagName==='SELECT'){const o=[...el.options].find(o=>o.value.toLowerCase()===String(val).toLowerCase());if(o){el.value=o.value;flash(el);filled++;}}
      else{el.value=String(val);flash(el);filled++;}
    });
    sEl.className='ai-status done';
    sEl.innerHTML=`âœ… Gemini filled <strong>${filled}</strong> fields. Verify highlighted fields before submitting.`;
    toast(`AI FILLED ${filled} FIELDS`,'ok');
    autoEmail();
    aiProgressDone(`AI FILLED ${filled} FIELDS`, 'âœ…');
  }catch(e){sEl.className='ai-status fail';sEl.innerHTML='âŒ '+e.message;toast('OCR ERROR: '+e.message,'err');aiProgressDone('OCR ERROR','âŒ');}
  document.getElementById('btn-ocr').disabled=false;
}

function flash(el){el.classList.add('ai-fill');setTimeout(()=>el.classList.remove('ai-fill'),4000);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PHOTO UPLOAD (registration tab)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let phEd=null, finalPhoto=null;
function initPhotoEditor(dataUrl) {
  document.getElementById('ph-editor').classList.add('show');
  document.getElementById('btn-upload-photo').style.display='inline-flex';
  document.getElementById('btn-compress-photo').style.display='inline-flex';
  finalPhoto = dataUrl;
  document.getElementById('ph-preview').innerHTML=`<img src="${dataUrl}"/><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>`;
  if (!phEd) phEd = new ImageEditor({
    canvasId:'ph-canvas', wrapId:'ph-canvas-wrap', cropBtnId:'ph-crop-btn',
    applyBtnId:'ph-apply-btn', sizeBadgeId:'ph-size',
    onCompressed: (rawUrl) => {
      finalPhoto = rawUrl;
      document.getElementById('ph-preview').innerHTML=`<img src="${rawUrl}"/><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>`;
    }
  });
  phEd.load(dataUrl);
}
document.getElementById('ph-file').onchange = e => {
  const f = e.target.files[0]; if (!f) return;
  toast('LOADING PHOTOâ€¦', 'inf');
  const reader = new FileReader();
  reader.onload = ev => { initPhotoEditor(ev.target.result); toast('PHOTO LOADED â€” EDIT THEN COMPRESS', 'ok'); };
  reader.readAsDataURL(f);
};

async function compressPhoto() {
  if (!phEd) { toast('NO PHOTO LOADED', 'err'); return; }
  const btn = document.getElementById('btn-compress-photo');
  btn.disabled = true; btn.textContent = 'â³ COMPRESSINGâ€¦';
  const rawUrl = phEd.getDataUrl();
  const { base64, bytes } = await compressBlob(rawUrl);
  finalPhoto = base64;
  document.getElementById('ph-preview').innerHTML=`<img src="${base64}"/><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>`;
  document.getElementById('ph-size').textContent = fmtKB(bytes) + ' (compressed)';
  btn.disabled = false; btn.textContent = 'âš¡ COMPRESS';
  toast(`COMPRESSED TO ${fmtKB(bytes)}`, 'ok');
}

async function uploadPhoto(){
  if(!finalPhoto){toast('NO PHOTO TO UPLOAD','err');return;}
  const idNum=document.getElementById('r-idNumber').value.trim();
  if(!idNum){toast('ENTER ID NUMBER FIRST','err');return;}
  if(!SB_URL){toast('CONNECT TO SUPABASE FIRST','err');return;}
  const btn=document.getElementById('btn-upload-photo');
  btn.disabled=true; btn.textContent='â³ UPLOADINGâ€¦';
  try{
    const phCol=tableColumns.size===0||tableColumns.has('photoBase64');
    if(!phCol){toast('photoBase64 COLUMN NOT IN TABLE â€” SKIPPED','err');return;}
    try{await supa(`${TABLE}?idNumber=eq.${encodeURIComponent(idNum)}`,{method:'PATCH',body:JSON.stringify({photoBase64:finalPhoto})});toast('PHOTO UPDATED IN SUPABASE','ok');}
    catch{await supa(TABLE,{method:'POST',body:JSON.stringify({idNumber:idNum,photoBase64:finalPhoto})});toast('PHOTO SAVED TO SUPABASE','ok');}
  }catch(e){toast('UPLOAD FAILED: '+e.message,'err');}
  btn.disabled=false; btn.textContent='â¬† UPLOAD PHOTO';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOCUMENT UPLOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let docEd=null, finalDoc=null;
function initDocEditor(dataUrl) {
  document.getElementById('doc-editor').classList.add('show');
  document.getElementById('btn-upload-doc').style.display='inline-flex';
  document.getElementById('btn-compress-doc').style.display='inline-flex';
  document.getElementById('doc-person-bar').style.display='flex';
  finalDoc = dataUrl;
  document.getElementById('doc-preview').innerHTML=`<img src="${dataUrl}"/><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>`;
  if (!docEd) docEd = new ImageEditor({
    canvasId:'doc-canvas', wrapId:'doc-canvas-wrap', cropBtnId:'doc-crop-btn',
    applyBtnId:'doc-apply-btn', sizeBadgeId:'doc-size',
    onCompressed: (rawUrl) => {
      finalDoc = rawUrl;
      document.getElementById('doc-preview').innerHTML=`<img src="${rawUrl}"/><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>`;
    }
  });
  docEd.load(dataUrl);
}
document.getElementById('doc-file').onchange = e => {
  const f = e.target.files[0]; if (!f) return;
  toast('LOADING DOCUMENTâ€¦', 'inf');
  const reader = new FileReader();
  reader.onload = ev => { initDocEditor(ev.target.result); toast('DOCUMENT LOADED â€” EDIT THEN COMPRESS', 'ok'); };
  reader.readAsDataURL(f);
};

async function compressDoc() {
  if (!docEd) { toast('NO DOCUMENT LOADED', 'err'); return; }
  const btn = document.getElementById('btn-compress-doc');
  btn.disabled = true; btn.textContent = 'â³ COMPRESSINGâ€¦';
  const rawUrl = docEd.getDataUrl();
  const { base64, bytes } = await compressBlob(rawUrl, 80);
  finalDoc = base64;
  document.getElementById('doc-preview').innerHTML=`<img src="${base64}"/><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>`;
  document.getElementById('doc-size').textContent = fmtKB(bytes) + ' (compressed)';
  btn.disabled = false; btn.textContent = 'âš¡ COMPRESS';
  toast(`COMPRESSED TO ${fmtKB(bytes)}`, 'ok');
}

async function uploadDoc(){
  if(!finalDoc){toast('NO DOCUMENT TO UPLOAD','err');return;}
  const idNum=document.getElementById('r-idNumber').value.trim();
  if(!idNum){toast('ENTER ID NUMBER FIRST','err');return;}
  if(!SB_URL){toast('CONNECT TO SUPABASE FIRST','err');return;}
  const btn=document.getElementById('btn-upload-doc');
  btn.disabled=true; btn.textContent='â³ UPLOADINGâ€¦';
  try{
    const docCol=tableColumns.size===0||tableColumns.has('photoBase64');
    if(!docCol){toast('photoBase64 COLUMN NOT IN TABLE â€” SKIPPED','err');return;}
    try{await supa(`${TABLE}?idNumber=eq.${encodeURIComponent(idNum)}`,{method:'PATCH',body:JSON.stringify({photoBase64:finalDoc})});toast('DOCUMENT UPDATED IN SUPABASE','ok');}
    catch{await supa(TABLE,{method:'POST',body:JSON.stringify({idNumber:idNum,photoBase64:finalDoc})});toast('DOCUMENT SAVED TO SUPABASE','ok');}
  }catch(e){toast('UPLOAD FAILED: '+e.message,'err');}
  btn.disabled=false; btn.textContent='â¬† UPLOAD DOC';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIGHTBOX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openLightbox(type){
  const src=type==='photo'?finalPhoto:finalDoc;
  if(!src)return;
  document.getElementById('lb-img').src=src;
  document.getElementById('lightbox').classList.add('on');
}
function closeLightbox(){ document.getElementById('lightbox').classList.remove('on'); }
document.getElementById('lightbox').onclick=closeLightbox;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADDRESS SMART-FILL (Gemini)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runAddressFill(){
  const gemKey=document.getElementById('cfg-gemini').value.trim();
  if(!gemKey){toast('ENTER GEMINI API KEY IN CONFIG','err');return;}
  const state=document.getElementById('r-state').value.trim();
  const district=document.getElementById('r-district').value.trim();
  const city=document.getElementById('r-city').value.trim();
  const pincode=document.getElementById('r-pincode').value.trim();
  if(!state&&!district&&!city&&!pincode){toast('ENTER AT LEAST ONE ADDRESS FIELD FIRST','err');return;}
  const st=document.getElementById('addr-ai-status');
  st.innerHTML='<span style="color:var(--blue);">â³ AI CHECKING ADDRESSâ€¦</span>';
  const btn=document.querySelector('[onclick="runAddressFill()"]');btn.disabled=true;
  aiProgressAnim('GEMINI SMART-FILL â€” VERIFYING ADDRESSâ€¦', 'ğŸŒ', 6000);
  const payload={contents:[{parts:[{text:`You are an expert on Indian geography.
Fix spelling and fill missing address fields consistently. Return ONLY JSON:
{"state":null,"district":null,"city":null,"pincode":null}
Current: state="${state}", district="${district}", city="${city}", pincode="${pincode}"`}]}],generationConfig:{temperature:0.1,maxOutputTokens:300}};
  try{
    const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${gemKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!res.ok){const e=await res.json();throw new Error(e.error?.message);}
    const data=await res.json();
    let txt=(data.candidates?.[0]?.content?.parts||[]).map(p=>p.text||'').join('').trim().replace(/^```(?:json)?\s*/i,'').replace(/\s*```\s*$/i,'');
    const fields=JSON.parse(txt);
    let n=0;
    ['state','district','city','pincode'].forEach(k=>{if(fields[k]&&fields[k]!=='null'){const el=document.getElementById('r-'+k);if(el.value.trim()!==fields[k]){el.value=fields[k];flash(el);n++;}}});
    st.innerHTML=n>0?`<span style="color:var(--green);">âœ… ${n} FIELD(S) CORRECTED</span>`:'<span style="color:#888;">âœ… ADDRESS LOOKS CORRECT</span>';
    toast(`ADDRESS SMART-FILL DONE (${n} CHANGES)`,'ok');
    aiProgressDone(n>0?`${n} FIELD(S) CORRECTED`:'ADDRESS LOOKS CORRECT','âœ…');
  }catch(e){st.innerHTML=`<span style="color:var(--red);">âŒ ${e.message}</span>`;toast('ADDRESS AI ERROR: '+e.message,'err');aiProgressDone('ADDRESS AI ERROR','âŒ');}
  btn.disabled=false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMAIL AUTO-GENERATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function autoEmail(){
  const el=document.getElementById('r-email');if(el.value.trim())return;
  const name=(document.getElementById('r-sevakName').value.trim()+document.getElementById('r-surName').value.trim()).replace(/\s+/g,'').toLowerCase();
  const dob=document.getElementById('r-dob').value.trim();
  let dp='';if(dob){const p=dob.split('/');if(p.length===3)dp=p[0].padStart(2,'0')+p[1].padStart(2,'0')+p[2].slice(-2);else dp=dob.replace(/\D/g,'').slice(0,6);}
  if(name){el.value=`${name}${dp}@gmail.com`;flash(el);toast('EMAIL AUTO-GENERATED','inf');}
}
['r-sevakName','r-surName','r-dob'].forEach(id=>document.getElementById(id).addEventListener('blur',autoEmail));

// DOB format
document.getElementById('r-dob').addEventListener('input',function(){
  let v=this.value.replace(/\D/g,'');if(v.length>8)v=v.slice(0,8);
  if(v.length>=5)v=v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4);
  else if(v.length>=3)v=v.slice(0,2)+'/'+v.slice(2);
  this.value=v;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUBMIT REGISTRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitForm(){
  const required=['r-idNumber','r-code','r-sevakName','r-dob','r-mobileNo','r-gender','r-state'];
  for(const id of required){if(!document.getElementById(id).value.trim()){toast('REQUIRED FIELD MISSING: '+id.replace('r-','').toUpperCase(),'err');document.getElementById(id).focus();return;}}
  if(!SB_URL){toast('CONNECT TO SUPABASE FIRST','err');return;}
  autoEmail();
  const btn=document.getElementById('btn-submit');btn.disabled=true;btn.textContent='â³ SUBMITTINGâ€¦';
  aiProgressAnim('UPLOADING REGISTRATION TO SUPABASEâ€¦', 'â¬†', 8000);
  const ids=['idNumber','code','sevakName','surName','fatherOrSpouseName','dob','mobileNo','email','gender','state','district','city','street','doorNo','pincode'];
  const raw={};
  ids.forEach(id=>{const v=document.getElementById('r-'+id)?.value.trim();if(v)raw[id]=v;});
  if(finalPhoto) raw.photoBase64=finalPhoto;
  // Strip any keys not present in the actual table schema
  const data=filterToColumns(raw);
  try{
    await supa(TABLE,{method:'POST',body:JSON.stringify(data)});
    toast('âœ… REGISTRATION SUBMITTED!','ok');
    aiProgressDone('REGISTRATION SAVED!','âœ…');
    await fetchAll();
    setTimeout(()=>{if(confirm('Saved! Clear form for next entry?'))resetRegForm();},1300);
  }catch(e){toast('SUBMIT FAILED: '+e.message,'err');aiProgressDone('SUBMIT FAILED','âŒ');}
  btn.disabled=false; btn.textContent='ğŸš€ SUBMIT REGISTRATION';
}

function resetRegForm(){
  ['idNumber','code','sevakName','surName','fatherOrSpouseName','dob','mobileNo','email','state','district','city','street','doorNo','pincode'].forEach(id=>{const el=document.getElementById('r-'+id);if(el)el.value='';});
  document.getElementById('r-gender').value='';
  finalPhoto=null;finalDoc=null;aiEd=null;phEd=null;docEd=null;
  document.getElementById('ph-preview').innerHTML='<span>No photo selected</span>';
  document.getElementById('doc-preview').innerHTML='<span>No document selected</span>';
  ['ph-editor','doc-editor','ai-editor'].forEach(id=>document.getElementById(id).classList.remove('show'));
  document.getElementById('doc-person-bar').style.display='none';
  document.getElementById('ocr-status').style.display='none';
  document.getElementById('btn-upload-photo').style.display='none';
  document.getElementById('btn-compress-photo').style.display='none';
  document.getElementById('btn-upload-doc').style.display='none';
  document.getElementById('btn-compress-doc').style.display='none';
  document.getElementById('addr-ai-status').textContent='';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AI PROGRESS BANNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _aiProgressTimer = null;
function aiProgress(show, text='', step='', pct=0, icon='ğŸ¤–') {
  const banner = document.getElementById('ai-progress-banner');
  const fill = document.getElementById('ai-progress-bar-fill');
  if (!show) {
    banner.classList.remove('show');
    clearInterval(_aiProgressTimer);
    return;
  }
  document.getElementById('ai-progress-text').textContent = text || 'AI IS WORKINGâ€¦';
  document.getElementById('ai-progress-step').textContent = step;
  document.getElementById('ai-progress-icon').textContent = icon;
  fill.style.width = pct + '%';
  banner.classList.add('show');
  // Scroll top so banner is visible
  window.scrollTo({top: 0, behavior: 'smooth'});
}
function aiProgressAnim(text, icon='ğŸ¤–', durationMs=8000) {
  aiProgress(true, text, '', 5, icon);
  let pct = 5;
  clearInterval(_aiProgressTimer);
  _aiProgressTimer = setInterval(() => {
    pct = Math.min(pct + (Math.random() * 8 + 2), 88);
    document.getElementById('ai-progress-bar-fill').style.width = pct + '%';
    const steps = ['ENCODING IMAGEâ€¦','SENDING TO GEMINIâ€¦','READING FIELDSâ€¦','PROCESSING RESPONSEâ€¦','FILLING FORMâ€¦'];
    document.getElementById('ai-progress-step').textContent = steps[Math.floor(pct/20)] || '';
  }, durationMs/12);
}
function aiProgressDone(successText='DONE', successIcon='âœ…') {
  clearInterval(_aiProgressTimer);
  document.getElementById('ai-progress-bar-fill').style.width = '100%';
  document.getElementById('ai-progress-text').textContent = successText;
  document.getElementById('ai-progress-icon').textContent = successIcon;
  document.getElementById('ai-progress-step').textContent = '';
  setTimeout(() => aiProgress(false), 2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETECT & CROP PERSON PHOTO FROM DOCUMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function detectAndCropPerson() {
  const gemKey = document.getElementById('cfg-gemini').value.trim();
  if (!gemKey) { toast('ENTER GEMINI API KEY IN CONFIG', 'err'); return; }
  if (!docEd) { toast('LOAD A DOCUMENT FIRST', 'err'); return; }
  const st = document.getElementById('crop-person-status');
  st.innerHTML = '<span style="color:#FFE500">â³ DETECTINGâ€¦</span>';
  aiProgressAnim('DETECTING PERSON PHOTO IN DOCUMENTâ€¦', 'ğŸ§‘â€ğŸ’¼', 10000);

  try {
    // Get display canvas for sending to Gemini (already scaled to reasonable size)
    const displayCanvas = docEd.displayCanvas;
    const srcCanvas     = docEd.srcCanvas;
    const b64  = displayCanvas.toDataURL('image/jpeg', 0.95).split(',')[1];
    const imgW = displayCanvas.width, imgH = displayCanvas.height;

    const payload = {
      contents: [{
        parts: [
          { inline_data: { mime_type: 'image/jpeg', data: b64 } },
          { text: `This is an identity document or form that may contain a person's photo (passport photo, stamp-size photo pasted on the form, or a face in the document).
Find the person photo/face region and return its bounding box as pixel coordinates relative to the image dimensions (width=${imgW}, height=${imgH}).
Return ONLY a valid JSON object like: {"found":true,"x":10,"y":20,"w":80,"h":100}
If no person photo found, return: {"found":false}
NO markdown, NO explanation, ONLY the JSON.` }
        ]
      }],
      generationConfig: { temperature: 0.05, maxOutputTokens: 200 }
    };

    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${gemKey}`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.error?.message || 'Gemini error'); }
    const data = await res.json();
    let txt = (data.candidates?.[0]?.content?.parts || []).map(p => p.text || '').join('').trim();
    txt = txt.replace(/^```(?:json)?\s*/i, '').replace(/\s*```\s*$/i, '').trim();
    const box = JSON.parse(txt);

    if (!box.found) {
      st.innerHTML = '<span style="color:#E63030">âŒ NO PERSON PHOTO DETECTED</span>';
      aiProgressDone('NO PERSON PHOTO FOUND', 'âŒ');
      toast('No person photo detected in document', 'err');
      return;
    }

    // Add some padding
    const pad = 8;
    const cx = Math.max(0, box.x - pad);
    const cy = Math.max(0, box.y - pad);
    const cw = Math.min(imgW - cx, box.w + pad * 2);
    const ch = Math.min(imgH - cy, box.h + pad * 2);

    // Map display coords â†’ srcCanvas full-res coords
    const scaleX = srcCanvas.width  / imgW;
    const scaleY = srcCanvas.height / imgH;
    const cropCanvas = document.createElement('canvas');
    cropCanvas.width  = Math.round(cw * scaleX);
    cropCanvas.height = Math.round(ch * scaleY);
    cropCanvas.getContext('2d').drawImage(
      srcCanvas,
      Math.round(cx * scaleX), Math.round(cy * scaleY),
      cropCanvas.width, cropCanvas.height,
      0, 0, cropCanvas.width, cropCanvas.height
    );

    const croppedDataUrl = cropCanvas.toDataURL('image/jpeg', 0.95);
    // Load into photo editor (user can compress manually after)
    initPhotoEditor(croppedDataUrl);

    st.innerHTML = '<span style="color:#00C16A">âœ… PHOTO CROPPED & LOADED INTO PHOTO SLOT</span>';
    aiProgressDone('PERSON PHOTO EXTRACTED!', 'âœ…');
    toast('PERSON PHOTO DETECTED & MOVED TO PHOTO SLOT', 'ok');

    // Switch photo section into view
    document.getElementById('ph-editor').scrollIntoView({ behavior: 'smooth', block: 'center' });

  } catch(e) {
    st.innerHTML = `<span style="color:#E63030">âŒ ${e.message}</span>`;
    aiProgressDone('ERROR DETECTING PHOTO', 'âŒ');
    toast('DETECT ERROR: ' + e.message, 'err');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT â€” EXCEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportExcel() {
  if (!displayRecords.length) { toast('NO RECORDS TO EXPORT', 'err'); return; }
  toast('BUILDING EXCELâ€¦', 'inf');

  const cols = ['idNumber','code','sevakName','surName','fatherOrSpouseName','dob','gender','mobileNo','email','state','district','city','street','doorNo','pincode'];
  const headers = ['ID Number','Code','Sevak Name','Surname','Father/Spouse','DOB','Gender','Mobile','Email','State','District','City','Street','Door No','Pincode'];

  // Build XLSX manually (XML-based Office Open XML)
  const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

  let sharedStrings = [], ssMap = {};
  const si = str => {
    const k = String(str||'');
    if (ssMap[k] === undefined) { ssMap[k] = sharedStrings.length; sharedStrings.push(k); }
    return ssMap[k];
  };

  // Pre-index all strings
  headers.forEach(h => si(h));
  displayRecords.forEach(r => cols.forEach(c => si(r[c]||'')));

  // Sheet rows
  let rows = '';
  // Header row
  let hcells = headers.map((h,i) => `<c r="${colLetter(i)}1" t="s"><v>${si(h)}</v></c>`).join('');
  rows += `<row r="1">${hcells}</row>`;
  // Data rows
  displayRecords.forEach((r, ri) => {
    const rn = ri + 2;
    const cells = cols.map((c,ci) => `<c r="${colLetter(ci)}${rn}" t="s"><v>${si(r[c]||'')}</v></c>`).join('');
    rows += `<row r="${rn}">${cells}</row>`;
  });

  function colLetter(i) {
    let s = ''; i++;
    while (i > 0) { s = String.fromCharCode(64 + (i % 26 || 26)) + s; i = Math.floor((i - 1) / 26); }
    return s;
  }

  const ssXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" count="${sharedStrings.length}" uniqueCount="${sharedStrings.length}">
${sharedStrings.map(s=>`<si><t xml:space="preserve">${esc(s)}</t></si>`).join('')}
</sst>`;

  const sheetXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
<sheetData>${rows}</sheetData>
</worksheet>`;

  const wbXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"
 xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
<sheets><sheet name="Sevak Registry" sheetId="1" r:id="rId1"/></sheets>
</workbook>`;

  const relsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings" Target="sharedStrings.xml"/>
</Relationships>`;

  const wbRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
</Relationships>`;

  const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="xml" ContentType="application/xml"/>
<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
<Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
<Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/>
</Types>`;

  // Pack into ZIP using a tiny inline ZIP builder
  const zip = buildZip([
    { name: '[Content_Types].xml',        data: contentTypes },
    { name: '_rels/.rels',                data: wbRels },
    { name: 'xl/workbook.xml',            data: wbXml },
    { name: 'xl/_rels/workbook.xml.rels', data: relsXml },
    { name: 'xl/worksheets/sheet1.xml',   data: sheetXml },
    { name: 'xl/sharedStrings.xml',       data: ssXml },
  ]);

  const blob = new Blob([zip], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `sevak-registry-${Date.now()}.xlsx`; a.click();
  URL.revokeObjectURL(url);
  toast(`EXPORTED ${displayRecords.length} RECORDS TO EXCEL`, 'ok');
}

// Minimal ZIP builder (store method, no compression â€” fine for XML files)
function buildZip(files) {
  const enc = s => new TextEncoder().encode(s);
  const u32 = n => { const b=new Uint8Array(4); new DataView(b.buffer).setUint32(0,n,true); return b; };
  const u16 = n => { const b=new Uint8Array(2); new DataView(b.buffer).setUint16(0,n,true); return b; };

  function crc32(buf) {
    let c=0xFFFFFFFF;
    const t=new Uint32Array(256);
    for(let i=0;i<256;i++){let x=i;for(let j=0;j<8;j++)x=x&1?0xEDB88320^(x>>>1):x>>>1;t[i]=x;}
    for(const b of buf)c=t[(c^b)&0xFF]^(c>>>8);
    return (c^0xFFFFFFFF)>>>0;
  }

  function dos() {
    const d=new Date();
    return ((d.getFullYear()-1980)<<25|(d.getMonth()+1)<<21|d.getDate()<<16|d.getHours()<<11|d.getMinutes()<<5|Math.floor(d.getSeconds()/2))>>>0;
  }

  const parts=[]; const central=[]; let offset=0;
  for(const f of files){
    const name=enc(f.name); const data=enc(f.data);
    const crc=crc32(data); const dt=dos();
    const local=concatU8([
      new Uint8Array([0x50,0x4B,0x03,0x04,0x14,0x00,0x00,0x00,0x00,0x00]),
      u32(dt), u32(crc), u32(data.length), u32(data.length),
      u16(name.length), u16(0), name, data
    ]);
    central.push(concatU8([
      new Uint8Array([0x50,0x4B,0x01,0x02,0x14,0x00,0x14,0x00,0x00,0x00,0x00,0x00]),
      u32(dt), u32(crc), u32(data.length), u32(data.length),
      u16(name.length), u16(0), u16(0), u16(0), u16(0), u32(0), u32(offset), name
    ]));
    offset+=local.length; parts.push(local);
  }
  const cd=concatU8(central);
  const eocd=concatU8([
    new Uint8Array([0x50,0x4B,0x05,0x06,0x00,0x00,0x00,0x00]),
    u16(files.length), u16(files.length), u32(cd.length), u32(offset), u16(0)
  ]);
  return concatU8([...parts, cd, eocd]);
}

function concatU8(arrays) {
  const total=arrays.reduce((s,a)=>s+a.length,0);
  const out=new Uint8Array(total); let off=0;
  for(const a of arrays){out.set(a,off);off+=a.length;}
  return out;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT â€” PDF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPDF() {
  if (!displayRecords.length) { toast('NO RECORDS TO EXPORT', 'err'); return; }
  toast('BUILDING PDFâ€¦', 'inf');

  // Build a print-ready HTML page and open it
  const filterInfo = [
    document.getElementById('flt-code').value ? 'Code: '+document.getElementById('flt-code').value : '',
    document.getElementById('flt-gender').value ? 'Gender: '+document.getElementById('flt-gender').value : '',
    document.getElementById('flt-state').value ? 'State: '+document.getElementById('flt-state').value : '',
    document.getElementById('search-input').value ? 'Search: "'+document.getElementById('search-input').value+'"' : '',
  ].filter(Boolean).join(' Â· ') || 'All Records';

  const rows = displayRecords.map((r,i) => {
    const name = [r.sevakName, r.surName].filter(Boolean).join(' ') || 'â€”';
    const photo = r.photoBase64
      ? `<img src="${r.photoBase64.startsWith('data:')?r.photoBase64:'data:image/jpeg;base64,'+r.photoBase64}" style="width:48px;height:48px;object-fit:cover;border:2px solid #000;display:block;">`
      : `<div style="width:48px;height:48px;background:#ffe500;border:2px solid #000;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;">${(r.sevakName||'?')[0].toUpperCase()}</div>`;
    const loc = [r.city, r.district, r.state].filter(Boolean).join(', ') || 'â€”';
    return `<tr style="background:${i%2?'#fafaf5':'#fff'}">
      <td style="padding:8px;text-align:center;font-size:12px;color:#888;">${i+1}</td>
      <td style="padding:8px;">${photo}</td>
      <td style="padding:8px;"><strong style="font-size:13px;">${name}</strong><br><span style="font-size:10px;color:#888;font-family:monospace;">${r.idNumber||''}</span></td>
      <td style="padding:8px;font-family:monospace;font-size:11px;background:#111;color:#ffe500;font-weight:700;">${r.code||'â€”'}</td>
      <td style="padding:8px;font-size:12px;">${r.dob||'â€”'}</td>
      <td style="padding:8px;font-size:12px;">${r.gender||'â€”'}</td>
      <td style="padding:8px;font-size:12px;">${r.mobileNo||'â€”'}</td>
      <td style="padding:8px;font-size:12px;">${loc}</td>
    </tr>`;
  }).join('');

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
<title>Sevak Registry Export</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;700&display=swap');
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'DM Sans',sans-serif;background:#fff;color:#111;padding:24px;}
  .header{background:#111;color:#ffe500;padding:20px 24px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:flex-end;}
  .header h1{font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:3px;}
  .header .meta{font-size:11px;opacity:.7;text-align:right;line-height:1.8;}
  .filter-bar{background:#ffe500;border:2px solid #000;padding:8px 16px;font-size:11px;font-weight:700;letter-spacing:1px;margin-bottom:16px;text-transform:uppercase;}
  table{width:100%;border-collapse:collapse;border:3px solid #000;}
  thead tr{background:#111;}
  th{padding:10px 8px;text-align:left;font-size:9px;color:#ffe500;letter-spacing:2px;text-transform:uppercase;font-family:monospace;font-weight:400;}
  tbody tr{border-bottom:1px solid #e8e4dc;}
  .footer{margin-top:16px;font-size:10px;color:#aaa;text-align:center;}
  @media print{body{padding:8px;}@page{margin:10mm;}}
</style></head><body>
<div class="header">
  <div>
    <h1>SEVAK REGISTRY</h1>
    <div style="font-size:11px;opacity:.6;margin-top:4px;letter-spacing:2px;">OFFICIAL ROSTER EXPORT</div>
  </div>
  <div class="meta">
    EXPORTED: ${new Date().toLocaleString('en-IN')}<br>
    TOTAL RECORDS: ${displayRecords.length}<br>
    TABLE: ${TABLE}
  </div>
</div>
<div class="filter-bar">FILTER: ${filterInfo}</div>
<table>
  <thead><tr>
    <th>#</th><th>PHOTO</th><th>NAME / ID</th><th>CODE</th>
    <th>DOB</th><th>GENDER</th><th>MOBILE</th><th>LOCATION</th>
  </tr></thead>
  <tbody>${rows}</tbody>
</table>
<div class="footer">SEVAK REGISTRY Â· Generated ${new Date().toLocaleString('en-IN')} Â· ${displayRecords.length} records</div>
<script>window.onload=()=>window.print();<\/script>
</body></html>`;

  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  toast(`PDF ROSTER READY â€” ${displayRecords.length} RECORDS`, 'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BULK REGISTER  â€”  one full form per person
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let bkPersons = [];   // meta: {_name, _id, _saved}
let bkCurrent = 0;    // active index
// per-person editor state keyed by idx
const bkSt = {}; // {idx: {aiEd,phEd,docEd,finalPhoto,finalDoc}}

function bkState(i) {
  if (!bkSt[i]) bkSt[i] = { aiEd:null, phEd:null, docEd:null, finalPhoto:null, finalDoc:null };
  return bkSt[i];
}

// â”€â”€ field helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bkEl(i, field)  { return document.getElementById(`bk${i}-${field}`); }
function bkVal(i, field) { return bkEl(i,field)?.value?.trim()||''; }

// â”€â”€ sidebar update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bkRenderSidebar() {
  document.getElementById('bk-badge').textContent = bkPersons.length;
  const list = document.getElementById('bk-list');
  if (!bkPersons.length) {
    list.innerHTML = `<div style="color:#444;font-family:'Space Mono',monospace;font-size:9px;text-align:center;padding:20px 8px;line-height:1.8;">USE BUTTONS<br>BELOW TO ADD</div>`;
    document.getElementById('bk-empty').style.display = 'flex';
    document.getElementById('bk-topbar').style.display = 'none';
    return;
  }
  document.getElementById('bk-empty').style.display = 'none';
  document.getElementById('bk-topbar').style.display = '';
  list.innerHTML = bkPersons.map((p,i) => {
    const photo = bkSt[i]?.finalPhoto;
    return `<div class="bk-card${i===bkCurrent?' active':''}${p._saved?' saved':''}" id="bkcard-${i}" onclick="bkGoTo(${i})">
      ${photo ? `<img class="bk-card-img" src="${photo}">` : `<div class="bk-card-ph">ğŸ‘¤</div>`}
      <div class="bk-card-info">
        <div class="bk-card-name">${p._name}</div>
        <div class="bk-card-id">${p._id}</div>
      </div>
      ${p._saved?'<div class="bk-card-sts">âœ…</div>':''}
      <button class="bk-del-btn" onclick="event.stopPropagation();bkDelete(${i})">âœ•</button>
    </div>`;
  }).join('');
}

function bkUpdateCard(i) {
  const name = [bkVal(i,'sevakName'),bkVal(i,'surName')].filter(Boolean).join(' ') || 'PERSON '+(i+1);
  const id   = bkVal(i,'idNumber') || 'â€”';
  if (bkPersons[i]) { bkPersons[i]._name = name; bkPersons[i]._id = id; }
  const card = document.getElementById('bkcard-'+i);
  if (!card) return;
  card.querySelector('.bk-card-name').textContent = name;
  card.querySelector('.bk-card-id').textContent   = id;
  const photo = bkSt[i]?.finalPhoto;
  const old   = card.querySelector('.bk-card-img, .bk-card-ph');
  if (old) old.outerHTML = photo ? `<img class="bk-card-img" src="${photo}">` : `<div class="bk-card-ph">ğŸ‘¤</div>`;
}

function bkUpdateTopbar() {
  const n = bkPersons.length;
  document.getElementById('bk-counter').textContent = n ? `${bkCurrent+1} / ${n}` : 'â€”';
  document.getElementById('bk-prev').disabled = bkCurrent === 0;
  document.getElementById('bk-next').disabled = bkCurrent >= n-1;
  document.getElementById('bk-lbl').textContent = bkPersons[bkCurrent]?._name || '';
}

// â”€â”€ navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bkGoTo(i) {
  document.getElementById(`bkform-${bkCurrent}`)?.classList.remove('active');
  document.getElementById(`bkcard-${bkCurrent}`)?.classList.remove('active');
  bkCurrent = i;
  document.getElementById(`bkform-${i}`)?.classList.add('active');
  const card = document.getElementById(`bkcard-${i}`);
  card?.classList.add('active');
  card?.scrollIntoView({behavior:'smooth',block:'nearest'});
  bkUpdateTopbar();
}

function bkNav(dir) {
  const next = bkCurrent + dir;
  if (next >= 0 && next < bkPersons.length) bkGoTo(next);
}

// â”€â”€ add person â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bkAdd(photoDataUrl=null) {
  const i = bkPersons.length;
  bkPersons.push({ _name:'PERSON '+(i+1), _id:'â€”', _saved:false });
  bkSt[i] = { aiEd:null, phEd:null, docEd:null, finalPhoto:photoDataUrl, finalDoc:null };

  // inject form HTML
  document.getElementById('bk-forms').insertAdjacentHTML('beforeend', bkFormHtml(i));
  bkWire(i);

  // if photo provided, load into photo AND AI handwriting editors right away
  if (photoDataUrl) setTimeout(() => {
    bkInitPhoto(i, photoDataUrl);
    bkInitAi(i, photoDataUrl);
  }, 50);

  bkRenderSidebar();
  bkGoTo(i);
}

function bkDelete(i) {
  if (!confirm(`Remove Person ${i+1}?`)) return;
  document.getElementById(`bkform-${i}`)?.remove();
  bkPersons.splice(i,1);
  delete bkSt[i];
  // re-index bkSt
  const newSt = {};
  Object.keys(bkSt).forEach(k => {
    const ki = +k; if (ki > i) newSt[ki-1] = bkSt[ki]; else if (ki < i) newSt[ki] = bkSt[ki];
  });
  Object.keys(bkSt).forEach(k=>delete bkSt[k]);
  Object.assign(bkSt, newSt);
  bkCurrent = Math.min(bkCurrent, Math.max(0, bkPersons.length-1));
  bkReRender();
}

function bkClearAll() {
  if (bkPersons.length && !confirm('Clear all persons?')) return;
  bkPersons = []; Object.keys(bkSt).forEach(k=>delete bkSt[k]); bkCurrent = 0;
  document.getElementById('bk-forms').innerHTML = '';
  document.getElementById('bk-log').style.display = 'none';
  document.getElementById('bk-prog-wrap').style.display = 'none';
  bkRenderSidebar(); bkUpdateTopbar();
}

function bkReRender() {
  // rebuild all cards â€” forms already exist in DOM (just re-render sidebar + activate current)
  bkRenderSidebar();
  // re-activate current
  document.querySelectorAll('.bk-person-form').forEach(f => f.classList.remove('active'));
  document.getElementById(`bkform-${bkCurrent}`)?.classList.add('active');
  bkUpdateTopbar();
}

// â”€â”€ import photos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bkImportPhotos(files) {
  [...files].forEach(f => {
    const r = new FileReader();
    r.onload = ev => bkAdd(ev.target.result);
    r.readAsDataURL(f);
  });
  document.getElementById('bk-photos-input').value = '';
  toast(`IMPORTING ${files.length} PHOTO${files.length>1?'S':''}â€¦`, 'inf');
}

// â”€â”€ form HTML â€” identical to Register New â”€â”€â”€â”€â”€
function bkFormHtml(i) {
  const p = `bk${i}`;
  return `<div class="bk-person-form" id="bkform-${i}">

  <!-- AI OCR -->
  <div class="reg-section" style="border-left:none;border-right:none;border-top:none;margin:0;">
    <div class="reg-sect-head"><span class="ico">ğŸ¤–</span><div><h3>AI HANDWRITING RECOGNITION</h3><p>Upload handwritten form â†’ Gemini scans â†’ Fields auto-filled</p></div></div>
    <div class="reg-sect-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start;">
        <div>
          <div class="upload-zone" id="${p}-ai-zone">
            <input type="file" id="${p}-ai-file" accept="image/*">
            <div class="uz-ico">ğŸ“„</div>
            <p><strong>Click or drag & drop</strong> handwritten form image</p>
          </div>
          <div class="img-editor" id="${p}-ai-editor">
            <div class="editor-toolbar">
              <span>EDIT:</span>
              <button class="nb nb-ghost nb-sm" onclick="bkSt[${i}].aiEd?.rotate(-90)">â†º LEFT</button>
              <button class="nb nb-ghost nb-sm" onclick="bkSt[${i}].aiEd?.rotate(90)">â†» RIGHT</button>
              <button class="nb nb-ghost nb-sm" id="${p}-ai-crop-btn" onclick="bkSt[${i}].aiEd?.toggleCrop()">âœ‚ CROP</button>
              <button class="nb nb-yellow nb-sm" id="${p}-ai-apply-btn" style="display:none" onclick="bkSt[${i}].aiEd?.applyCrop()">âœ… APPLY</button>
              <button class="nb nb-ghost nb-sm" onclick="bkSt[${i}].aiEd?.reset()">â†º RESET</button>
            </div>
            <div class="canvas-wrap" id="${p}-ai-canvas-wrap"><canvas id="${p}-ai-canvas" class="ec"></canvas></div>
            <div class="editor-footer">
              <button class="nb nb-blue nb-sm" id="${p}-btn-ocr" onclick="bkRunOcr(${i})">ğŸ” RUN GEMINI SCAN</button>
              <span class="size-badge" id="${p}-ai-size"></span>
            </div>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div class="how-box"><strong>HOW IT WORKS:</strong><br>1ï¸âƒ£ Upload handwritten form photo<br>2ï¸âƒ£ Crop / rotate for clarity<br>3ï¸âƒ£ Click <em>Run Gemini Scan</em><br>4ï¸âƒ£ Fields auto-filled below<br>5ï¸âƒ£ Verify & correct before saving</div>
          <div id="${p}-ocr-status" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- FIELDS -->
  <div class="reg-section" style="border-left:none;border-right:none;border-top:none;margin:0;">
    <div class="reg-sect-head"><span class="ico">ğŸ“</span><div><h3>REGISTRATION DETAILS</h3><p>Fill manually or use AI above</p></div></div>
    <div class="reg-sect-body">
      <div class="fg">
        <div class="fld" id="${p}-fld-idNumber"><label>ID Number <span class="req">*</span></label><input id="${p}-idNumber" placeholder="e.g. SVK-0001" oninput="bkUpdateCard(${i})"></div>
        <div class="fld"><label>Code <span class="req">*</span></label><input id="${p}-code" placeholder="e.g. CODE001"></div>
        <div class="fld" id="${p}-fld-sevakName"><label>Sevak Name <span class="req">*</span></label><input id="${p}-sevakName" placeholder="First / Given Name" oninput="bkUpdateCard(${i})"></div>
        <div class="fld"><label>Surname</label><input id="${p}-surName" placeholder="Last Name" oninput="bkUpdateCard(${i})"></div>
        <div class="fld"><label>Father / Spouse Name</label><input id="${p}-fatherOrSpouseName" placeholder="Father or Spouse"></div>
        <div class="fld" id="${p}-fld-dob"><label>Date of Birth <span class="req">*</span></label><input id="${p}-dob" placeholder="DD/MM/YYYY" maxlength="10"></div>
        <div class="fld" id="${p}-fld-mobileNo"><label>Mobile <span class="req">*</span></label><input id="${p}-mobileNo" type="tel" placeholder="10-digit mobile" maxlength="10"></div>
        <div class="fld"><label>Email</label><input id="${p}-email" type="email" placeholder="email@example.com"></div>
        <div class="fld" id="${p}-fld-gender"><label>Gender <span class="req">*</span></label>
          <select id="${p}-gender"><option value="">Select Gender</option><option>Male</option><option>Female</option><option>Other</option></select>
        </div>
        <div class="fld" id="${p}-fld-state"><label>State <span class="req">*</span></label><input id="${p}-state" placeholder="State"></div>
        <div class="fld"><label>District</label><input id="${p}-district" placeholder="District"></div>
        <div class="fld"><label>City</label><input id="${p}-city" placeholder="City / Town"></div>
        <div class="fld"><label>Street</label><input id="${p}-street" placeholder="Street / Colony"></div>
        <div class="fld"><label>Door No</label><input id="${p}-doorNo" placeholder="Door / Flat No."></div>
        <div class="fld"><label>Pincode</label><input id="${p}-pincode" placeholder="6-digit pincode" maxlength="6"></div>
      </div>
      <div class="addr-bar">
        <button class="nb nb-blue nb-sm" onclick="bkRunAddrFill(${i})">ğŸŒ SMART-FILL ADDRESS</button>
        <p>Fixes spelling Â· Fills missing address fields using Gemini</p>
        <span id="${p}-addr-status"></span>
      </div>
    </div>
  </div>

  <!-- PHOTO -->
  <div class="reg-section" style="border-left:none;border-right:none;border-top:none;margin:0;">
    <div class="reg-sect-head"><span class="ico">ğŸ“¸</span><div><h3>PHOTO</h3><p>Crop & rotate Â· Compress before saving</p></div></div>
    <div class="reg-sect-body">
      <div class="media-grid">
        <div>
          <div class="upload-zone" id="${p}-ph-zone">
            <input type="file" id="${p}-ph-file" accept="image/*">
            <div class="uz-ico">ğŸ–¼ï¸</div>
            <p><strong>Click</strong> to select photo</p>
          </div>
          <div class="img-editor" id="${p}-ph-editor">
            <div class="editor-toolbar">
              <span>EDIT:</span>
              <button class="nb nb-ghost nb-sm" onclick="bkSt[${i}].phEd?.rotate(-90)">â†º LEFT</button>
              <button class="nb nb-ghost nb-sm" onclick="bkSt[${i}].phEd?.rotate(90)">â†» RIGHT</button>
              <button class="nb nb-ghost nb-sm" id="${p}-ph-crop-btn" onclick="bkSt[${i}].phEd?.toggleCrop()">âœ‚ CROP</button>
              <button class="nb nb-yellow nb-sm" id="${p}-ph-apply-btn" style="display:none" onclick="bkSt[${i}].phEd?.applyCrop()">âœ… APPLY CROP</button>
              <button class="nb nb-ghost nb-sm" onclick="bkSt[${i}].phEd?.reset()">â†º RESET</button>
            </div>
            <div class="canvas-wrap" id="${p}-ph-canvas-wrap"><canvas id="${p}-ph-canvas" class="ec"></canvas></div>
            <div class="editor-footer">
              <span class="size-badge" id="${p}-ph-size"></span>
              <button class="nb nb-orange nb-sm" onclick="bkCompressPhoto(${i})">âš¡ COMPRESS</button>
            </div>
          </div>
        </div>
        <div class="preview-box" id="${p}-ph-preview" onclick="bkLightbox(${i},'photo')">
          <span>No photo selected</span><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>
        </div>
      </div>
    </div>
  </div>

  <!-- DOCUMENT -->
  <div class="reg-section" style="border-left:none;border-right:none;border-top:none;margin:0;">
    <div class="reg-sect-head"><span class="ico">ğŸªª</span><div><h3>DOCUMENT / ID IMAGE</h3><p>Upload ID proof Â· Crop & rotate</p></div></div>
    <div class="reg-sect-body">
      <div class="media-grid">
        <div>
          <div class="upload-zone" id="${p}-doc-zone">
            <input type="file" id="${p}-doc-file" accept="image/*">
            <div class="uz-ico">ğŸªª</div>
            <p><strong>Click</strong> to select document</p>
          </div>
          <div class="img-editor" id="${p}-doc-editor">
            <div class="editor-toolbar">
              <span>EDIT:</span>
              <button class="nb nb-ghost nb-sm" onclick="bkSt[${i}].docEd?.rotate(-90)">â†º LEFT</button>
              <button class="nb nb-ghost nb-sm" onclick="bkSt[${i}].docEd?.rotate(90)">â†» RIGHT</button>
              <button class="nb nb-ghost nb-sm" id="${p}-doc-crop-btn" onclick="bkSt[${i}].docEd?.toggleCrop()">âœ‚ CROP</button>
              <button class="nb nb-yellow nb-sm" id="${p}-doc-apply-btn" style="display:none" onclick="bkSt[${i}].docEd?.applyCrop()">âœ… APPLY</button>
              <button class="nb nb-ghost nb-sm" onclick="bkSt[${i}].docEd?.reset()">â†º RESET</button>
            </div>
            <div class="canvas-wrap" id="${p}-doc-canvas-wrap"><canvas id="${p}-doc-canvas" class="ec"></canvas></div>
            <div class="editor-footer">
              <span class="size-badge" id="${p}-doc-size"></span>
              <button class="nb nb-orange nb-sm" onclick="bkCompressDoc(${i})">âš¡ COMPRESS</button>
            </div>
          </div>
        </div>
        <div class="preview-box" id="${p}-doc-preview" onclick="bkLightbox(${i},'doc')">
          <span>No document selected</span><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>
        </div>
      </div>
    </div>
  </div>

</div>`;
}

// â”€â”€ wire events for a newly created form â”€â”€â”€â”€â”€â”€
function bkWire(i) {
  const p = `bk${i}`, st = bkState(i);

  // DOB auto-format
  bkEl(i,'dob').addEventListener('input', function(){
    let v=this.value.replace(/\D/g,''); if(v.length>8)v=v.slice(0,8);
    if(v.length>=5) v=v.slice(0,2)+'/'+v.slice(2,4)+'/'+v.slice(4);
    else if(v.length>=3) v=v.slice(0,2)+'/'+v.slice(2);
    this.value=v;
  });

  // AI file
  document.getElementById(`${p}-ai-file`).onchange = e => {
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload = ev => {
      document.getElementById(`${p}-ai-editor`).classList.add('show');
      if (!st.aiEd) st.aiEd = new ImageEditor({canvasId:`${p}-ai-canvas`,wrapId:`${p}-ai-canvas-wrap`,cropBtnId:`${p}-ai-crop-btn`,applyBtnId:`${p}-ai-apply-btn`,sizeBadgeId:`${p}-ai-size`});
      st.aiEd.load(ev.target.result);
    };
    r.readAsDataURL(f);
  };

  // Photo file
  document.getElementById(`${p}-ph-file`).onchange = e => {
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload = ev => bkInitPhoto(i, ev.target.result);
    r.readAsDataURL(f);
  };

  // Doc file
  document.getElementById(`${p}-doc-file`).onchange = e => {
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload = ev => bkInitDoc(i, ev.target.result);
    r.readAsDataURL(f);
  };
}

// â”€â”€ photo/doc init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bkInitPhoto(i, dataUrl) {
  const p=`bk${i}`, st=bkState(i);
  st.finalPhoto = dataUrl;
  document.getElementById(`${p}-ph-editor`).classList.add('show');
  document.getElementById(`${p}-ph-preview`).innerHTML = `<img src="${dataUrl}"><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>`;
  if (!st.phEd) {
    st.phEd = new ImageEditor({
      canvasId:`${p}-ph-canvas`, wrapId:`${p}-ph-canvas-wrap`,
      cropBtnId:`${p}-ph-crop-btn`, applyBtnId:`${p}-ph-apply-btn`, sizeBadgeId:`${p}-ph-size`,
      onCompressed: raw => {
        st.finalPhoto = raw;
        document.getElementById(`${p}-ph-preview`).innerHTML = `<img src="${raw}"><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>`;
        bkUpdateCard(i);
      }
    });
  }
  st.phEd.load(dataUrl);
  bkUpdateCard(i);
}

function bkInitDoc(i, dataUrl) {
  const p=`bk${i}`, st=bkState(i);
  st.finalDoc = dataUrl;
  document.getElementById(`${p}-doc-editor`).classList.add('show');
  document.getElementById(`${p}-doc-preview`).innerHTML = `<img src="${dataUrl}"><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>`;
  if (!st.docEd) {
    st.docEd = new ImageEditor({
      canvasId:`${p}-doc-canvas`, wrapId:`${p}-doc-canvas-wrap`,
      cropBtnId:`${p}-doc-crop-btn`, applyBtnId:`${p}-doc-apply-btn`, sizeBadgeId:`${p}-doc-size`,
      onCompressed: raw => {
        st.finalDoc = raw;
        document.getElementById(`${p}-doc-preview`).innerHTML = `<img src="${raw}"><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>`;
      }
    });
  }
  st.docEd.load(dataUrl);
}

function bkInitAi(i, dataUrl) {
  const p=`bk${i}`, st=bkState(i);
  document.getElementById(`${p}-ai-editor`).classList.add('show');
  if (!st.aiEd) {
    st.aiEd = new ImageEditor({
      canvasId:`${p}-ai-canvas`, wrapId:`${p}-ai-canvas-wrap`,
      cropBtnId:`${p}-ai-crop-btn`, applyBtnId:`${p}-ai-apply-btn`, sizeBadgeId:`${p}-ai-size`
    });
  }
  st.aiEd.load(dataUrl);
}

async function bkCompressPhoto(i) {
  const st=bkState(i), p=`bk${i}`;
  if (!st.phEd) { toast('LOAD A PHOTO FIRST','err'); return; }
  const {base64,bytes} = await compressBlob(st.phEd.getDataUrl());
  st.finalPhoto = base64;
  document.getElementById(`${p}-ph-preview`).innerHTML = `<img src="${base64}"><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>`;
  document.getElementById(`${p}-ph-size`).textContent = fmtKB(bytes)+' (compressed)';
  bkUpdateCard(i);
  toast(`COMPRESSED TO ${fmtKB(bytes)}`,'ok');
}

async function bkCompressDoc(i) {
  const st=bkState(i), p=`bk${i}`;
  if (!st.docEd) { toast('LOAD A DOCUMENT FIRST','err'); return; }
  const {base64,bytes} = await compressBlob(st.docEd.getDataUrl(),80);
  st.finalDoc = base64;
  document.getElementById(`${p}-doc-preview`).innerHTML = `<img src="${base64}"><div class="zoom-hint">ğŸ” CLICK TO VIEW FULL SIZE</div>`;
  document.getElementById(`${p}-doc-size`).textContent = fmtKB(bytes)+' (compressed)';
  toast(`COMPRESSED TO ${fmtKB(bytes)}`,'ok');
}

function bkLightbox(i, type) {
  const src = type==='photo' ? bkSt[i]?.finalPhoto : bkSt[i]?.finalDoc;
  if (!src) return;
  document.getElementById('lb-img').src = src;
  document.getElementById('lightbox').classList.add('on');
}

// â”€â”€ AI OCR per person â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bkRunOcr(i) {
  const gemKey = document.getElementById('cfg-gemini').value.trim();
  if (!gemKey) { toast('ENTER GEMINI API KEY IN CONFIG','err'); return; }
  const st=bkState(i), p=`bk${i}`;
  if (!st.aiEd) { toast('UPLOAD A FORM IMAGE FIRST','err'); return; }

  const sEl = document.getElementById(`${p}-ocr-status`);
  sEl.style.display='flex'; sEl.className='ai-status proc';
  sEl.innerHTML='<div class="spinner"></div><span>Gemini is reading the handwritingâ€¦</span>';
  document.getElementById(`${p}-btn-ocr`).disabled=true;
  aiProgressAnim('GEMINI OCR â€” READING HANDWRITINGâ€¦','ğŸ”',12000);

  try {
    const b64 = st.aiEd.getDataUrl().split(',')[1];
    const payload = {
      contents:[{parts:[
        {inline_data:{mime_type:'image/jpeg',data:b64}},
        {text:`You are a precise OCR assistant for handwritten Indian registration forms.
Extract ONLY these fields. Return ONLY a valid JSON object (null for unreadable):
{"idNumber":null,"code":null,"sevakName":null,"surName":null,"fatherOrSpouseName":null,"dob":null,"mobileNo":null,"email":null,"gender":null,"state":null,"district":null,"city":null,"street":null,"doorNo":null,"pincode":null}
Rules: dob in DD/MM/YYYY, gender must be "Male"/"Female"/"Other". NO markdown, NO explanation.`}
      ]}],
      generationConfig:{temperature:0.05,maxOutputTokens:2048}
    };

    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${gemKey}`,
      {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if (!res.ok) { const e=await res.json(); throw new Error(e.error?.message||'Gemini error'); }
    const data = await res.json();
    const text = (data.candidates?.[0]?.content?.parts||[]).map(p=>p.text||'').join('').trim();
    if (!text) throw new Error('Gemini returned empty response');
    let clean = text.replace(/^```(?:json)?\s*/i,'').replace(/\s*```\s*$/i,'').trim();
    let fields;
    try { fields=JSON.parse(clean); }
    catch(_) { const m=clean.match(/\{[\s\S]*\}/); if(!m) throw new Error('No JSON in response'); fields=JSON.parse(m[0]); }

    let filled=0;
    Object.entries(fields).forEach(([key,val])=>{
      const el=document.getElementById(`${p}-${key}`);
      if(!el||!val||val==='null') return;
      if(key==='gender'&&el.tagName==='SELECT'){
        const o=[...el.options].find(o=>o.value.toLowerCase()===String(val).toLowerCase());
        if(o){el.value=o.value;flash(el);filled++;}
      } else { el.value=String(val); flash(el); filled++; }
    });

    bkUpdateCard(i);
    sEl.className='ai-status done';
    sEl.innerHTML=`âœ… Gemini filled <strong>${filled}</strong> fields. Verify before saving.`;
    aiProgressDone(`AI FILLED ${filled} FIELDS`,'âœ…');
    toast(`AI FILLED ${filled} FIELDS`,'ok');
  } catch(e) {
    sEl.className='ai-status fail'; sEl.innerHTML='âŒ '+e.message;
    aiProgressDone('OCR ERROR','âŒ'); toast('OCR ERROR: '+e.message,'err');
  }
  document.getElementById(`${p}-btn-ocr`).disabled=false;
}

// â”€â”€ address smart-fill per person â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bkRunAddrFill(i) {
  const gemKey = document.getElementById('cfg-gemini').value.trim();
  if (!gemKey) { toast('ENTER GEMINI API KEY IN CONFIG','err'); return; }
  const p=`bk${i}`;
  const state=bkVal(i,'state'), district=bkVal(i,'district'), city=bkVal(i,'city'), pincode=bkVal(i,'pincode');
  if (!state&&!district&&!city&&!pincode) { toast('ENTER AT LEAST ONE ADDRESS FIELD FIRST','err'); return; }

  const stEl = document.getElementById(`${p}-addr-status`);
  stEl.innerHTML='<span style="color:var(--blue);">â³ AI CHECKINGâ€¦</span>';
  aiProgressAnim('GEMINI SMART-FILL â€” VERIFYING ADDRESSâ€¦','ğŸŒ',6000);

  try {
    const payload={contents:[{parts:[{text:`You are an expert on Indian geography.
Fix spelling and fill missing address fields. Return ONLY JSON:
{"state":null,"district":null,"city":null,"pincode":null}
Current: state="${state}", district="${district}", city="${city}", pincode="${pincode}". NO markdown.`}]}],generationConfig:{temperature:0.1,maxOutputTokens:300}};
    const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${gemKey}`,
      {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!res.ok){const e=await res.json();throw new Error(e.error?.message);}
    const data=await res.json();
    let txt=(data.candidates?.[0]?.content?.parts||[]).map(p=>p.text||'').join('').trim()
      .replace(/^```(?:json)?\s*/i,'').replace(/\s*```\s*$/i,'');
    const fields=JSON.parse(txt);
    let n=0;
    ['state','district','city','pincode'].forEach(k=>{
      if(fields[k]&&fields[k]!=='null'){
        const el=bkEl(i,k);
        if(el&&el.value.trim()!==fields[k]){el.value=fields[k];flash(el);n++;}
      }
    });
    stEl.innerHTML=n>0?`<span style="color:var(--green);">âœ… ${n} FIELD(S) CORRECTED</span>`:'<span style="color:#888;">âœ… ADDRESS LOOKS CORRECT</span>';
    aiProgressDone(n>0?`${n} CORRECTED`:'ADDRESS OK','âœ…');
  } catch(e) {
    stEl.innerHTML=`<span style="color:var(--red);">âŒ ${e.message}</span>`;
    aiProgressDone('ADDRESS AI ERROR','âŒ');
  }
}

// â”€â”€ save all â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function bkSaveAll() {
  if (!SB_URL) { toast('CONNECT TO SUPABASE FIRST','err'); return; }
  if (!bkPersons.length) { toast('NO PERSONS TO SAVE','err'); return; }

  // validate required fields
  const req = ['idNumber','code','sevakName','dob','mobileNo','gender','state'];
  let errors=0;
  bkPersons.forEach((_,i)=>{
    req.forEach(f=>{
      const fld=document.getElementById(`bk${i}-fld-${f}`);
      if(!bkVal(i,f)) { if(fld) fld.classList.add('berr'); errors++; }
      else { if(fld) fld.classList.remove('berr'); }
    });
  });
  if (errors) {
    toast(`${errors} REQUIRED FIELD${errors>1?'S':''} MISSING â€” CHECK RED FIELDS`,'err');
    for(let i=0;i<bkPersons.length;i++){
      if(req.some(f=>!bkVal(i,f))){bkGoTo(i);break;}
    }
    return;
  }

  const saveBtn = document.querySelector('#bk-topbar .nb-black');
  saveBtn.disabled=true; saveBtn.textContent='â³ SAVINGâ€¦';
  const prog=document.getElementById('bk-prog-wrap'), fill=document.getElementById('bk-prog-fill'), txt=document.getElementById('bk-prog-txt');
  const log=document.getElementById('bk-log');
  prog.style.display=''; log.style.display=''; log.innerHTML='';

  let saved=0,failed=0;
  for(let i=0;i<bkPersons.length;i++){
    const pct=Math.round(i/bkPersons.length*100);
    fill.style.width=pct+'%'; txt.textContent=`${pct}% â€” saving ${i+1}/${bkPersons.length}`;
    bkGoTo(i);

    const st=bkState(i);
    let photo=st.finalPhoto;
    if(photo){try{const r=await compressBlob(photo);photo=r.base64;}catch(_){}}

    const raw={};
    ['idNumber','code','sevakName','surName','fatherOrSpouseName','dob','mobileNo','email','gender','state','district','city','street','doorNo','pincode']
      .forEach(k=>{const v=bkVal(i,k);if(v)raw[k]=v;});
    if(photo) raw.photoBase64=photo;
    const data=filterToColumns(raw);

    try {
      try { await supa(`${TABLE}?idNumber=eq.${encodeURIComponent(raw.idNumber)}`,{method:'PATCH',body:JSON.stringify(data)}); }
      catch(_){ await supa(TABLE,{method:'POST',body:JSON.stringify(data)}); }
      saved++; bkPersons[i]._saved=true;
      const card=document.getElementById('bkcard-'+i);
      if(card){card.classList.add('saved');const s=card.querySelector('.bk-card-sts');if(s)s.textContent='âœ…';}
      log.innerHTML+=`<div style="color:var(--green)">âœ… [${i+1}] ${raw.sevakName||''} ${raw.surName||''} (${raw.idNumber})</div>`;
    } catch(e) {
      failed++;
      log.innerHTML+=`<div style="color:var(--red)">âŒ [${i+1}] ${raw.idNumber} â€” ${e.message}</div>`;
    }
    log.scrollTop=log.scrollHeight;
  }

  fill.style.width='100%'; txt.textContent=`Done â€” ${saved} saved${failed?`, ${failed} failed`:''}`;
  saveBtn.disabled=false; saveBtn.textContent='ğŸš€ SAVE ALL';
  toast(`BULK SAVE: ${saved} SAVED${failed?`, ${failed} FAILED`:''}`  ,saved>0?'ok':'err');
  await fetchAll();
  if(!failed&&confirm(`All ${saved} records saved! Clear for next batch?`)) bkClearAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INLINE CODE EDITING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startInlineCodeEdit(td, r) {
  if (td.querySelector('input')) return;
  const currentCode = r.code || '';
  td.innerHTML = `
    <div style="display:flex;align-items:center;gap:4px;">
      <input id="inline-code-input" value="${currentCode.replace(/"/g,'&quot;')}"
        style="width:90px;font-family:'Space Mono',monospace;font-size:11px;
               padding:4px 7px;border:2px solid var(--yellow);outline:none;
               background:var(--black);color:var(--yellow);"
        onclick="event.stopPropagation()" />
      <button style="background:var(--green);color:#fff;border:none;padding:4px 8px;
                     font-weight:900;font-size:11px;cursor:pointer;"
              onclick="event.stopPropagation();saveInlineCode(this.closest('td'),${r.id},'${currentCode.replace(/'/g,"\\'")}')">âœ“</button>
      <button style="background:#888;color:#fff;border:none;padding:4px 8px;
                     font-weight:900;font-size:11px;cursor:pointer;"
              onclick="event.stopPropagation();cancelInlineCode(this.closest('td'),'${currentCode.replace(/'/g,"\\'")}')">âœ•</button>
    </div>`;
  const inp = td.querySelector('#inline-code-input');
  inp.focus(); inp.select();
  inp.onkeydown = (e) => {
    if (e.key === 'Enter') { e.preventDefault(); saveInlineCode(td, r.id, currentCode); }
    if (e.key === 'Escape') { e.preventDefault(); cancelInlineCode(td, currentCode); }
  };
}

function cancelInlineCode(td, originalCode) {
  td.innerHTML = `<span class="code-display nb-sm" style="background:var(--black);color:var(--yellow);font-family:'Space Mono',monospace;font-size:10px;padding:3px 8px;cursor:pointer;" title="Click to edit code">${originalCode||'â€”'}</span>`;
}

async function saveInlineCode(td, recordId, originalCode) {
  if (!SB_URL) { toast('NOT CONNECTED','err'); cancelInlineCode(td, originalCode); return; }
  const inp = td.querySelector('input');
  if (!inp) return;
  const newCode = inp.value.trim();
  if (newCode === originalCode) { cancelInlineCode(td, originalCode); return; }
  try {
    await supa(`${TABLE}?id=eq.${recordId}`, { method:'PATCH', body: JSON.stringify({ code: newCode }) });
    const rec = allRecords.find(r => r.id === recordId);
    if (rec) rec.code = newCode;
    const disp = displayRecords.find(r => r.id === recordId);
    if (disp) disp.code = newCode;
    buildCodeFilter();
    td.innerHTML = `<span class="code-display nb-sm" style="background:var(--black);color:var(--yellow);font-family:'Space Mono',monospace;font-size:10px;padding:3px 8px;cursor:pointer;" title="Click to edit code">${newCode||'â€”'}</span>`;
    const r2 = allRecords.find(r => r.id === recordId);
    if (r2) td.onclick = (e) => { e.stopPropagation(); startInlineCodeEdit(td, r2); };
    toast('CODE UPDATED âœ“','ok');
  } catch(e) {
    toast('SAVE FAILED: '+e.message,'err');
    cancelInlineCode(td, originalCode);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROW SELECTION (for bulk actions)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedIds = new Set();

function updateBulkBar() {
  const bar = document.getElementById('bulk-action-bar');
  const count = selectedIds.size;
  document.getElementById('bulk-sel-count').textContent = count;
  bar.classList.toggle('on', count > 0);
  const allChk = document.getElementById('chk-all');
  if (allChk) {
    const pageIds = getCurrentPageIds();
    const allChecked = pageIds.length > 0 && pageIds.every(id => selectedIds.has(id));
    allChk.checked = allChecked;
    allChk.indeterminate = !allChecked && pageIds.some(id => selectedIds.has(id));
  }
}

function getCurrentPageIds() {
  const total = displayRecords.length;
  const pages = Math.max(1, Math.ceil(total / PG));
  const pg = Math.min(curPage, pages);
  return displayRecords.slice((pg-1)*PG, pg*PG).map(r => r.id);
}

function toggleRowSelect(id, checked) {
  if (checked) selectedIds.add(id); else selectedIds.delete(id);
  const chk = document.querySelector(`input.row-chk[data-rid="${id}"]`);
  if (chk) chk.closest('tr').classList.toggle('selected-row', checked);
  updateBulkBar();
}

function toggleAllOnPage(masterChk) {
  const pageIds = getCurrentPageIds();
  pageIds.forEach(id => {
    if (masterChk.checked) selectedIds.add(id); else selectedIds.delete(id);
  });
  document.querySelectorAll('input.row-chk[data-rid]').forEach(chk => {
    const id = Number(chk.dataset.rid);
    if (pageIds.includes(id)) {
      chk.checked = masterChk.checked;
      chk.closest('tr').classList.toggle('selected-row', masterChk.checked);
    }
  });
  updateBulkBar();
}

function selectAllVisible() {
  displayRecords.forEach(r => selectedIds.add(r.id));
  document.querySelectorAll('input.row-chk[data-rid]').forEach(chk => {
    chk.checked = true;
    chk.closest('tr').classList.add('selected-row');
  });
  updateBulkBar();
}

function clearSelection() {
  selectedIds.clear();
  document.querySelectorAll('input.row-chk[data-rid]').forEach(chk => {
    chk.checked = false;
    chk.closest('tr').classList.remove('selected-row');
  });
  const allChk = document.getElementById('chk-all');
  if (allChk) { allChk.checked = false; allChk.indeterminate = false; }
  updateBulkBar();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UNIFIED TRANSFER MODAL (copy / move / bulk)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let transferMode = null;   // 'copy-single' | 'move-single' | 'copy-bulk' | 'move-bulk'
let transferSingleId = null;

function openCopyModal() {
  const r = activeRecord; if (!r) return;
  transferMode = 'copy-single';
  transferSingleId = r.id;
  const name = [r.sevakName, r.surName].filter(Boolean).join(' ') || r.idNumber;
  _openTransferModal(
    'COPY TO <span class="hi">TABLE</span>',
    `Copy <strong>${name}</strong> from <code style="background:#eee;padding:2px 7px;font-family:'Space Mono',monospace;font-size:12px;">${TABLE}</code> into another table.<br/><span style="font-size:12px;color:#999;">The original record <strong>stays</strong> in the current table.</span>`,
    'ğŸ“‹ COPY RECORD', 'nb-blue'
  );
}

function openMoveModal() {
  const r = activeRecord; if (!r) return;
  transferMode = 'move-single';
  transferSingleId = r.id;
  const name = [r.sevakName, r.surName].filter(Boolean).join(' ') || r.idNumber;
  _openTransferModal(
    'MOVE TO <span class="hi">TABLE</span>',
    `Move <strong>${name}</strong> from <code style="background:#eee;padding:2px 7px;font-family:'Space Mono',monospace;font-size:12px;">${TABLE}</code> to another table.<br/><span style="font-size:12px;color:#999;">Record will be <strong>inserted</strong> into target and <strong>deleted</strong> from current.</span>`,
    'ğŸ“¦ MOVE RECORD', 'nb-orange'
  );
}

function openBulkModal(type) {
  if (selectedIds.size === 0) { toast('SELECT RECORDS FIRST','err'); return; }
  transferMode = type + '-bulk';
  const n = selectedIds.size;
  if (type === 'copy') {
    _openTransferModal(
      `BULK COPY <span class="hi">${n} RECORDS</span>`,
      `Copy <strong>${n} selected record${n>1?'s':''}</strong> from <code style="background:#eee;padding:2px 7px;font-family:'Space Mono',monospace;font-size:12px;">${TABLE}</code> into another table.<br/><span style="font-size:12px;color:#999;">Originals <strong>stay</strong> in the current table.</span>`,
      `ğŸ“‹ COPY ${n} RECORDS`, 'nb-blue'
    );
  } else {
    _openTransferModal(
      `BULK MOVE <span class="hi">${n} RECORDS</span>`,
      `Move <strong>${n} selected record${n>1?'s':''}</strong> from <code style="background:#eee;padding:2px 7px;font-family:'Space Mono',monospace;font-size:12px;">${TABLE}</code> to another table.<br/><span style="font-size:12px;color:#999;">Records will be <strong>inserted</strong> into target then <strong>deleted</strong> from current.</span>`,
      `ğŸ“¦ MOVE ${n} RECORDS`, 'nb-orange'
    );
  }
}

function _openTransferModal(titleHtml, descHtml, btnLabel, btnClass) {
  document.getElementById('transfer-title').innerHTML = titleHtml;
  document.getElementById('transfer-desc').innerHTML = descHtml;
  document.getElementById('transfer-target').value = '';
  document.getElementById('transfer-status').textContent = '';
  document.getElementById('transfer-status').style.color = '';
  document.getElementById('transfer-log').innerHTML = '';
  document.getElementById('transfer-prog-fill').style.width = '0%';
  document.getElementById('transfer-prog-wrap').style.display = 'none';
  const btn = document.getElementById('transfer-btn');
  btn.textContent = btnLabel;
  btn.className = `nb ${btnClass}`;
  btn.disabled = false;
  btn.onclick = runTransfer;
  document.getElementById('transfer-overlay').classList.add('open');
  setTimeout(() => document.getElementById('transfer-target').focus(), 100);
}

function closeTransferModal() { document.getElementById('transfer-overlay').classList.remove('open'); }
function closeMoveModal() { closeTransferModal(); }
document.getElementById('transfer-overlay').onclick = e => { if(e.target===e.currentTarget) closeTransferModal(); };
document.getElementById('transfer-target').onkeydown = e => { if(e.key==='Enter') runTransfer(); };

async function runTransfer() {
  const target = document.getElementById('transfer-target').value.trim();
  if (!target) { toast('ENTER A TARGET TABLE NAME','err'); return; }
  if (target === TABLE) { toast('TARGET CANNOT BE THE SAME TABLE','err'); return; }
  if (!SB_URL) { toast('CONNECT TO SUPABASE FIRST','err'); return; }

  const statusEl = document.getElementById('transfer-status');
  const btn = document.getElementById('transfer-btn');
  btn.disabled = true;

  const isBulk = transferMode && transferMode.endsWith('-bulk');
  const isMove = transferMode && transferMode.startsWith('move');

  if (!isBulk) {
    // â”€â”€ SINGLE COPY / MOVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const rec = allRecords.find(r => r.id === transferSingleId);
    if (!rec) { toast('RECORD NOT FOUND','err'); btn.disabled=false; return; }
    const payload = {...rec}; delete payload.id;
    statusEl.style.color = 'var(--blue)';
    statusEl.textContent = `â³ Inserting into "${target}"â€¦`;
    try {
      await supa(target, { method:'POST', body: JSON.stringify(payload), headers:{'Prefer':'return=minimal'} });
      if (isMove) {
        statusEl.textContent = `â³ Removing from "${TABLE}"â€¦`;
        await supa(`${TABLE}?id=eq.${transferSingleId}`, { method:'DELETE' });
        allRecords = allRecords.filter(r => r.id !== transferSingleId);
        updateStats(); applyFilters();
      }
      statusEl.style.color = 'var(--green)';
      statusEl.textContent = `âœ… ${isMove?'Moved':'Copied'} to "${target}" successfully!`;
      toast(`${isMove?'MOVED':'COPIED'} TO "${target.toUpperCase()}"`, 'ok');
      setTimeout(() => { closeTransferModal(); if(isMove) switchTab('list'); }, 1200);
    } catch(e) {
      statusEl.style.color = 'var(--red)';
      statusEl.textContent = 'âŒ ' + e.message;
      toast(`${isMove?'MOVE':'COPY'} FAILED: `+e.message,'err');
    }
    btn.disabled = false;

  } else {
    // â”€â”€ BULK COPY / MOVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ids = [...selectedIds];
    const recs = ids.map(id => allRecords.find(r => r.id === id)).filter(Boolean);
    if (!recs.length) { toast('NO VALID RECORDS SELECTED','err'); btn.disabled=false; return; }

    const progWrap = document.getElementById('transfer-prog-wrap');
    const progFill = document.getElementById('transfer-prog-fill');
    const log = document.getElementById('transfer-log');
    progWrap.style.display = ''; log.innerHTML = '';
    statusEl.style.color = 'var(--blue)';

    let done=0, failed=0;
    const toDelete = [];

    for (let i=0; i<recs.length; i++) {
      const rec = recs[i];
      progFill.style.width = Math.round((i / recs.length) * 90) + '%';
      statusEl.textContent = `â³ ${isMove?'Moving':'Copying'} ${i+1} / ${recs.length}â€¦`;
      const payload = {...rec}; delete payload.id;
      try {
        await supa(target, { method:'POST', body: JSON.stringify(payload), headers:{'Prefer':'return=minimal'} });
        done++;
        if (isMove) toDelete.push(rec.id);
        const name = [rec.sevakName, rec.surName].filter(Boolean).join(' ') || rec.idNumber || `ID ${rec.id}`;
        log.innerHTML += `<div style="color:var(--green)">âœ… [${i+1}] ${name}</div>`;
      } catch(e) {
        failed++;
        const name = [rec.sevakName, rec.surName].filter(Boolean).join(' ') || rec.idNumber || `ID ${rec.id}`;
        log.innerHTML += `<div style="color:var(--red)">âŒ [${i+1}] ${name} â€” ${e.message}</div>`;
      }
      log.scrollTop = log.scrollHeight;
    }

    // batch-delete successfully transferred records if moving
    if (isMove && toDelete.length) {
      statusEl.textContent = `â³ Removing ${toDelete.length} records from "${TABLE}"â€¦`;
      const chunks = [];
      for (let i=0; i<toDelete.length; i+=10) chunks.push(toDelete.slice(i,i+10));
      for (const chunk of chunks) {
        try {
          const filter = chunk.map(id=>`id.eq.${id}`).join(',');
          await supa(`${TABLE}?or=(${filter})`, { method:'DELETE' });
        } catch(e) {
          log.innerHTML += `<div style="color:var(--red)">âš  DELETE BATCH FAILED: ${e.message}</div>`;
        }
      }
      const deleteSet = new Set(toDelete);
      allRecords = allRecords.filter(r => !deleteSet.has(r.id));
      selectedIds.clear();
      updateStats(); applyFilters(); updateBulkBar();
    }

    progFill.style.width = '100%';
    statusEl.style.color = failed > 0 ? 'var(--orange)' : 'var(--green)';
    statusEl.textContent = `${isMove?'MOVE':'COPY'} COMPLETE â€” ${done} OK${failed?`, ${failed} FAILED`:''}`;
    toast(`BULK ${isMove?'MOVE':'COPY'}: ${done} OK${failed?`, ${failed} FAILED`:''}`, done>0?'ok':'err');
    btn.disabled = false;
    btn.textContent = 'CLOSE';
    btn.className = 'nb nb-ghost';
    btn.onclick = closeTransferModal;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BULK CODE REASSIGN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openReassignModal() {
  if (selectedIds.size === 0) { toast('SELECT RECORDS FIRST', 'err'); return; }
  if (!SB_URL) { toast('CONNECT TO SUPABASE FIRST', 'err'); return; }

  const recs = [...selectedIds].map(id => allRecords.find(r => r.id === id)).filter(Boolean);

  // Build code breakdown
  const codeCounts = {};
  recs.forEach(r => {
    const c = r.code || '(no code)';
    codeCounts[c] = (codeCounts[c] || 0) + 1;
  });
  const breakdown = Object.entries(codeCounts)
    .sort((a,b) => b[1]-a[1])
    .map(([c,n]) => `<span style="color:var(--yellow);background:var(--black);padding:1px 7px;">${c}</span> Ã— ${n}`)
    .join('&nbsp;&nbsp;');

  document.getElementById('reassign-summary').innerHTML =
    `<strong style="font-size:10px;letter-spacing:1.5px;color:#555;">SELECTED: ${recs.length} RECORD${recs.length>1?'S':''} â€” CURRENT CODES:</strong><br/>${breakdown}`;

  document.getElementById('reassign-new-code').value = '';
  document.getElementById('reassign-preview').style.display = 'none';
  document.getElementById('reassign-preview').innerHTML = '';
  document.getElementById('reassign-status').textContent = '';
  document.getElementById('reassign-status').style.color = '';
  document.getElementById('reassign-log').innerHTML = '';
  document.getElementById('reassign-prog-fill').style.width = '0%';
  document.getElementById('reassign-prog-txt').textContent = '';
  document.getElementById('reassign-prog-wrap').style.display = 'none';

  const btn = document.getElementById('reassign-btn');
  btn.disabled = false; btn.textContent = 'ğŸ· APPLY TO ALL'; btn.onclick = runReassign;

  document.getElementById('reassign-overlay').classList.add('open');
  setTimeout(() => document.getElementById('reassign-new-code').focus(), 120);
}

function updateReassignPreview() {
  const newCode = document.getElementById('reassign-new-code').value.trim();
  const preview = document.getElementById('reassign-preview');
  if (!newCode) { preview.style.display = 'none'; return; }

  const recs = [...selectedIds].map(id => allRecords.find(r => r.id === id)).filter(Boolean);
  const changes = recs.filter(r => (r.code || '') !== newCode);
  const skipped = recs.length - changes.length;

  let html = `<strong style="color:var(--green);letter-spacing:1px;">PREVIEW â€” ${changes.length} WILL CHANGE${skipped ? `, ${skipped} ALREADY THIS CODE` : ''}:</strong><br/>`;
  const show = changes.slice(0, 8);
  show.forEach(r => {
    const name = [r.sevakName, r.surName].filter(Boolean).join(' ') || r.idNumber;
    const oldCode = r.code || '(none)';
    html += `${name}: <span style="color:#e63030;text-decoration:line-through;">${oldCode}</span> â†’ <span style="color:var(--green);font-weight:700;">${newCode}</span><br/>`;
  });
  if (changes.length > 8) html += `<span style="color:#888;">â€¦and ${changes.length - 8} more</span>`;
  if (changes.length === 0) html = `<span style="color:#888;">All selected records already have code <strong>${newCode}</strong>. Nothing to change.</span>`;

  preview.innerHTML = html;
  preview.style.display = 'block';
}

function closeReassignModal() {
  document.getElementById('reassign-overlay').classList.remove('open');
}
document.getElementById('reassign-overlay').onclick = e => { if (e.target === e.currentTarget) closeReassignModal(); };
document.getElementById('reassign-new-code').onkeydown = e => { if (e.key === 'Enter') runReassign(); };

async function runReassign() {
  const newCode = document.getElementById('reassign-new-code').value.trim();
  if (!newCode) { toast('ENTER A NEW CODE', 'err'); return; }
  if (!SB_URL) { toast('CONNECT TO SUPABASE FIRST', 'err'); return; }

  const recs = [...selectedIds]
    .map(id => allRecords.find(r => r.id === id))
    .filter(r => r && (r.code || '') !== newCode);  // skip already matching

  if (!recs.length) {
    toast('ALL SELECTED RECORDS ALREADY HAVE THIS CODE', 'err');
    return;
  }

  const btn = document.getElementById('reassign-btn');
  const statusEl = document.getElementById('reassign-status');
  const progWrap = document.getElementById('reassign-prog-wrap');
  const progFill = document.getElementById('reassign-prog-fill');
  const progTxt  = document.getElementById('reassign-prog-txt');
  const log      = document.getElementById('reassign-log');

  btn.disabled = true;
  progWrap.style.display = '';
  log.innerHTML = '';
  statusEl.textContent = '';

  let done = 0, failed = 0;

  for (let i = 0; i < recs.length; i++) {
    const rec = recs[i];
    const pct = Math.round((i / recs.length) * 95);
    progFill.style.width = pct + '%';
    progTxt.textContent = `${i + 1} / ${recs.length}`;
    statusEl.style.color = 'var(--blue)';
    statusEl.textContent = `â³ Updating ${i + 1} / ${recs.length}â€¦`;

    try {
      await supa(`${TABLE}?id=eq.${rec.id}`, {
        method: 'PATCH',
        body: JSON.stringify({ code: newCode })
      });
      // update in-memory
      rec.code = newCode;
      const disp = displayRecords.find(r => r.id === rec.id);
      if (disp) disp.code = newCode;
      done++;
      const name = [rec.sevakName, rec.surName].filter(Boolean).join(' ') || rec.idNumber;
      log.innerHTML += `<div style="color:var(--green)">âœ… [${i+1}] ${name} â†’ <strong>${newCode}</strong></div>`;
    } catch (e) {
      failed++;
      const name = [rec.sevakName, rec.surName].filter(Boolean).join(' ') || rec.idNumber;
      log.innerHTML += `<div style="color:var(--red)">âŒ [${i+1}] ${name} â€” ${e.message}</div>`;
    }
    log.scrollTop = log.scrollHeight;
  }

  progFill.style.width = '100%';
  progTxt.textContent = 'DONE';

  // refresh code filter and table
  buildCodeFilter();
  renderTable();

  statusEl.style.color = failed > 0 ? 'var(--orange)' : 'var(--green)';
  statusEl.textContent = `âœ… ${done} UPDATED${failed ? `, ${failed} FAILED` : ''}`;
  toast(`CODE REASSIGNED: ${done} RECORDS â†’ "${newCode}"${failed ? `, ${failed} FAILED` : ''}`, done > 0 ? 'ok' : 'err');

  btn.disabled = false;
  btn.textContent = 'CLOSE';
  btn.className = 'nb nb-ghost';
  btn.onclick = closeReassignModal;
}

// Initial hide search bar when not on list tab
switchTab('list');
</script>
</body>
</html>
